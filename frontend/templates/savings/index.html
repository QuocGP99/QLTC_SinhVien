{% extends "base.html" %} {% block title %}M·ª•c ti√™u ti·∫øt ki·ªám{% endblock %} {%
block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
<style>
  .goal-card {
    border: 1px solid #eef1f4;
    border-radius: 16px;
  }
  .goal-title {
    font-weight: 600;
  }
  .muted {
    color: #64748b;
  }
  .progress {
    height: 8px;
  }
  .goal-actions .icon-btn {
    width: 34px;
    height: 34px;
    border-radius: 10px;
    display: inline-grid;
    place-items: center;
    border: 1px solid #e9edf2;
    background: #fff;
  }
  .goal-actions .icon-btn:hover {
    background: #f8fafc;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-0">M·ª•c ti√™u ti·∫øt ki·ªám</h2>
      <div class="text-muted">Theo d√µi ti·∫øn ƒë·ªô ti·∫øt ki·ªám c√° nh√¢n</div>
    </div>
    <button
      class="btn btn-success"
      id="newGoalBtn"
      type="button"
      data-bs-toggle="modal"
      data-bs-target="#goalModal"
    >
      <i class="bi bi-plus-lg me-1"></i> Th√™m m·ª•c ti√™u
    </button>
  </div>

  <div class="row g-4 mb-3">
    <div class="col-lg-4">
      <div class="card kpi kpi-green">
        <div class="card-body">
          <div class="kpi-title">T·ªïng ƒë√£ ti·∫øt ki·ªám</div>
          <div class="kpi-value" id="kpiSaved">‚Ç´0</div>
          <div class="kpi-sub" id="kpiSavedSub">0% m·ª•c ti√™u</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card kpi kpi-blue">
        <div class="card-body">
          <div class="kpi-title">T·ªïng m·ª•c ti√™u</div>
          <div class="kpi-value" id="kpiTarget">‚Ç´0</div>
          <div class="kpi-sub" id="kpiActive">0 m·ª•c ti√™u ƒëang theo d√µi</div>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card kpi kpi-purple">
        <div class="card-body">
          <div class="kpi-title">ƒê√≥ng g√≥p h·∫±ng th√°ng</div>
          <div class="kpi-value" id="kpiMonthly">‚Ç´0</div>
          <div class="kpi-sub">T·ªïng ti·ªÅn g√≥p m·ªói th√°ng</div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4" id="goalsGrid"></div>

  <hr class="my-4" />
  <h5 class="mb-3">Th√†nh t·ª±u & m·ª•c ti√™u ƒë√£ ƒë√≥ng</h5>
  <div class="row g-4" id="goalsClosedGrid"></div>
</div>

{% include "savings/form.html" %} {% endblock %} {% block scripts %}
<script>
  (() => {
    const API_BASE = "/api";
    const TOKEN = localStorage.getItem("access_token") || "";
    const AUTH = TOKEN ? { Authorization: `Bearer ${TOKEN}` } : {};
    const qs = (s, el = document) => el.querySelector(s);
    const qsa = (s, el = document) => [...el.querySelectorAll(s)];
    const fmtVND = (n) =>
      Number(n || 0).toLocaleString("vi-VN", {
        style: "currency",
        currency: "VND",
        maximumFractionDigits: 0,
      });
    const pct = (cur, tgt) =>
      tgt > 0 ? Math.min(100, Math.round((cur * 100) / tgt)) : 0;

    let GOALS = [];

    async function apiGetList(status = "") {
      const url = new URL(`${API_BASE}/savings`, location.origin);
      if (status) url.searchParams.set("status", status);
      const r = await fetch(url, { headers: { ...AUTH } });
      if (!r.ok) throw new Error("GET /savings failed");
      const data = await r.json();
      const items = (data.items || data || []).map((g) => ({
        id: g.id,
        name: g.name,
        description: g.description || "",
        target_amount: +g.target_amount || 0,
        current_amount: +g.current_amount || 0,
        monthly_contribution: +g.monthly_contribution || 0,
        deadline: g.deadline || "",
        status: g.status || "active",
        auto_contribute: !!g.auto_contribute,
        contribute_interval: g.contribute_interval || "monthly",
        icon: "üí∞",
      }));
      return { items, notices: data.notices || [] };
    }

    function renderKPIs() {
      const totalSaved = GOALS.reduce(
        (s, g) => s + Number(g.current_amount || 0),
        0
      );
      const totalTarget = GOALS.reduce(
        (s, g) => s + Number(g.target_amount || 0),
        0
      );
      const monthly = GOALS.reduce(
        (s, g) => s + Number(g.monthly_contribution || 0),
        0
      );
      qs("#kpiSaved").textContent = fmtVND(totalSaved);
      qs("#kpiTarget").textContent = fmtVND(totalTarget);
      qs("#kpiMonthly").textContent = fmtVND(monthly);
      qs("#kpiSavedSub").textContent = `${pct(
        totalSaved,
        totalTarget
      )}% m·ª•c ti√™u`;
      qs("#kpiActive").textContent = `${GOALS.length} m·ª•c ti√™u ƒëang theo d√µi`;
    }

    function cardHTML(g) {
      const p = pct(g.current_amount, g.target_amount);
      const overdue =
        g.deadline &&
        new Date(g.deadline) < new Date(new Date().toDateString());
      return `
    <div class="col-xl-6" data-id="${g.id}">
      <div class="card goal-card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex align-items-center gap-2">
              <div style="font-size:1.25rem">${g.icon}</div>
              <div><div class="goal-title">${
                g.name
              }</div><div class="muted small">${g.description || ""}</div></div>
            </div>
            <div class="d-flex align-items-center gap-2 goal-actions">
              <button class="icon-btn btn-view-detail" title="Xem l·ªãch s·ª≠"><i class="bi bi-clock-history"></i></button>
              <button class="icon-btn btn-edit" title="S·ª≠a"><i class="bi bi-pencil"></i></button>
              <button class="icon-btn btn-del" title="X√≥a"><i class="bi bi-trash"></i></button>
              <button class="icon-btn btn-close-goal" title="ƒê√≥ng m·ª•c ti√™u"><i class="bi bi-check2-circle"></i></button>
            </div>
          </div>
          <div class="d-flex justify-content-between mt-3 mb-1">
            <div class="fw-semibold">${fmtVND(g.current_amount)}</div>
            <div class="muted">/ ${fmtVND(g.target_amount)}</div>
          </div>
          <div class="progress mb-1"><div class="progress-bar ${
            p >= 100 ? "bg-success" : "bg-dark"
          }" style="width:${p}%"></div></div>
          <div class="d-flex justify-content-between small">
            <span class="muted">${p}% ho√†n th√†nh</span>
            ${
              overdue
                ? '<span class="text-danger">Qu√° h·∫°n</span>'
                : '<span class="text-success">ƒê√∫ng ti·∫øn ƒë·ªô</span>'
            }
          </div>
        </div>
      </div>
    </div>`;
    }

    function render() {
      const wrap = qs("#goalsGrid");
      wrap.innerHTML = GOALS.map(cardHTML).join("");
      renderKPIs();
      bindCardEvents();
    }

    async function renderClosedPanels() {
      const closedGrid = qs("#goalsClosedGrid");
      const comp = await apiGetList("completed");
      const fail = await apiGetList("failed");
      const closed = [...(comp.items || []), ...(fail.items || [])];
      if (!closed.length) {
        closedGrid.innerHTML =
          '<div class="text-muted">Ch∆∞a c√≥ m·ª•c ti√™u ƒë√£ ƒë√≥ng.</div>';
        return;
      }
      closedGrid.innerHTML = closed
        .map((g) => {
          const p = pct(g.current_amount, g.target_amount);
          const statusLabel =
            g.status === "completed"
              ? '<span class="text-success">Ho√†n th√†nh</span>'
              : '<span class="text-danger">Ch∆∞a ho√†n th√†nh</span>';
          return `
      <div class="col-xl-6" data-id="${g.id}">
        <div class="card goal-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-items-center gap-2">
                <div style="font-size:1.25rem">${g.icon}</div>
                <div><div class="goal-title">${
                  g.name
                }</div><div class="muted small">${
            g.description || ""
          }</div></div>
              </div>
              <div class="d-flex align-items-center gap-2 goal-actions">
                ${
                  g.status === "completed"
                    ? '<button class="icon-btn btn-withdraw" title="R√∫t v·ªÅ v√≠"><i class="bi bi-wallet2"></i></button>'
                    : ""
                }
              </div>
            </div>
            <div class="d-flex justify-content-between mt-3 mb-1"><div class="fw-semibold">${fmtVND(
              g.current_amount
            )}</div><div class="muted">/ ${fmtVND(g.target_amount)}</div></div>
            <div class="progress mb-1"><div class="progress-bar ${
              p >= 100 ? "bg-success" : "bg-dark"
            }" style="width:${p}%"></div></div>
            <div class="d-flex justify-content-between small"><span class="muted">${p}%</span>${statusLabel}</div>
          </div>
        </div>
      </div>`;
        })
        .join("");
      closedGrid.querySelectorAll(".btn-withdraw")?.forEach((btn) => {
        const id = btn.closest("[data-id]").dataset.id;
        btn.addEventListener("click", async () => {
          if (!confirm("R√∫t to√†n b·ªô s·ªë ti·ªÅn ƒë√£ ti·∫øt ki·ªám v·ªÅ v√≠ c·ªßa b·∫°n?"))
            return;
          const r = await fetch(`${API_BASE}/savings/${id}/withdraw`, {
            method: "POST",
            headers: { ...AUTH },
          });
          if (!r.ok) return alert("R√∫t ti·ªÅn th·∫•t b·∫°i");
          const d = await r.json();
          alert(
            `ƒê√£ r√∫t ${Number(d.withdrawn || 0).toLocaleString(
              "vi-VN"
            )} ƒë v·ªÅ v√≠ c·ªßa b·∫°n.`
          );
          await boot();
        });
      });
    }

    function showSavingsNotices(n) {
      n.forEach((x) =>
        alert(x.message || x.msg || "C√≥ thay ƒë·ªïi ·ªü m·ª•c ti√™u ti·∫øt ki·ªám")
      );
    }

    function bindCardEvents() {
      qsa("#goalsGrid [data-id]").forEach((card) => {
        const id = card.dataset.id;
        card
          .querySelector(".btn-edit")
          ?.addEventListener("click", () => openModal(id));
        card.querySelector(".btn-del")?.addEventListener("click", async () => {
          if (!confirm("X√≥a m·ª•c ti√™u n√†y?")) return;
          await fetch(`${API_BASE}/savings/${id}`, {
            method: "DELETE",
            headers: { ...AUTH },
          });
          await boot();
        });
        card
          .querySelector(".btn-close-goal")
          ?.addEventListener("click", async () => {
            const g = GOALS.find((x) => x.id == id);
            const percent = pct(g.current_amount, g.target_amount);
            let status = "completed";
            if (percent < 100 && !confirm("M·ª•c ti√™u ch∆∞a ƒë·∫°t 100%. ƒê√≥ng l·∫°i?"))
              return;
            await fetch(`${API_BASE}/savings/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json", ...AUTH },
              body: JSON.stringify({ status }),
            });
            showSavingsNotices([
              {
                message:
                  "ƒê√£ ƒë√≥ng m·ª•c ti√™u. Ki·ªÉm tra ph·∫ßn Th√†nh t·ª±u ƒë·ªÉ r√∫t v·ªÅ v√≠.",
              },
            ]);
            await boot();
          });
      });
    }

    // ==== openModal & fillForm (ƒë·ªÉ s·ª≠a/th√™m) ====
    function fillForm(g) {
      const f = document.querySelector("#goalForm");
      f.id.value = g?.id || "";
      f.name.value = g?.name || "";
      f.description.value = g?.description || "";
      f.target_amount.value = g?.target_amount || "";
      f.deadline.value = window.__SAVINGS_DATE__?.parseISO(g?.deadline) || "";
      f.monthly_contribution.value = g?.monthly_contribution || 0;
      f.auto_contribute.checked = !!g?.auto_contribute;
      f.contribute_interval.value = g?.contribute_interval || "monthly";
    }
    function openModal(id) {
      const g = id
        ? (GOALS || []).find((x) => String(x.id) === String(id))
        : null;
      document.getElementById("goalModalTitle").textContent = g
        ? "Ch·ªânh s·ª≠a m·ª•c ti√™u"
        : "T·∫°o m·ª•c ti√™u ti·∫øt ki·ªám m·ªõi";
      fillForm(g);
      const el = document.getElementById("goalModal");
      const modal = new bootstrap.Modal(el);
      modal.show();
    }

    async function boot() {
      const { items, notices } = await apiGetList("active");
      GOALS = items;
      window.GOALS = GOALS;
      render();
      await renderClosedPanels();
      if (Array.isArray(notices) && notices.length) showSavingsNotices(notices);
    }

    // m·ªü modal ·ªü tr·∫°ng th√°i t·∫°o m·ªõi (reset form)
    qs("#newGoalBtn")?.addEventListener("click", () => openModal(null));

    // ====== SUBMIT FORM: t·∫°o / s·ª≠a m·ª•c ti√™u ======
    (function attachGoalFormSubmit() {
      const form = document.getElementById("goalForm");
      if (!form) return;

      const dmyToISO = (s) =>
        (window.__SAVINGS_DATE__?.toISO && window.__SAVINGS_DATE__.toISO(s)) ||
        (s
          ? (() => {
              const [dd, mm, yyyy] = String(s).split("/");
              return `${yyyy}-${mm}-${dd}`;
            })()
          : null);

      form.addEventListener("submit", async (e) => {
        e.preventDefault(); // <-- ch·∫∑n submit GET
        const fd = new FormData(form);
        const id = fd.get("id");

        const payload = {
          name: (fd.get("name") || "").trim(),
          description: (fd.get("description") || "").trim() || null,
          target_amount: Number(fd.get("target_amount") || 0),
          monthly_contribution: Number(fd.get("monthly_contribution") || 0),
          deadline: dmyToISO(fd.get("deadline")), // dd/mm/yyyy -> YYYY-MM-DD
          auto_contribute: !!fd.get("auto_contribute"),
          contribute_interval: fd.get("contribute_interval") || "monthly",
        };

        const res = await fetch(`${API_BASE}/savings${id ? `/${id}` : ""}`, {
          method: id ? "PUT" : "POST",
          headers: { "Content-Type": "application/json", ...AUTH },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const msg = await res.text().catch(() => "");
          alert("L∆∞u m·ª•c ti√™u th·∫•t b·∫°i: " + (msg || res.status));
          return;
        }

        // ƒê√≥ng modal an to√†n
        const modalInstance = bootstrap.Modal.getInstance(
          document.getElementById("goalModal")
        );
        if (modalInstance) {
          modalInstance.hide();
        }
        
        // Cleanup backdrop sau animation
        setTimeout(() => {
          document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
          document.body.classList.remove('modal-open');
          document.body.style.overflow = '';
          document.body.style.paddingRight = '';
          
          const modalEl = document.getElementById("goalModal");
          if (modalEl) {
            modalEl.style.display = 'none';
            modalEl.classList.remove('show');
            modalEl.setAttribute('aria-hidden', 'true');
            modalEl.removeAttribute('aria-modal');
          }
        }, 300);
        
        await boot();
      });
    })();

    document.addEventListener("DOMContentLoaded", () => boot());
  })();
</script>
{% endblock %}
