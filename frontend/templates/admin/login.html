{% extends 'base_admin.html' %} {% block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
<style>
  .auth-card {
    max-width: 420px;
    margin: 8vh auto;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <div class="auth-card card shadow-sm border-0">
    <div class="card-body p-4 p-md-5">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 class="h5 mb-0">Đăng nhập Quản trị</h1>
        <span class="badge text-bg-warning"
          ><i class="bi bi-shield-lock me-1"></i> Admin</span
        >
      </div>
      <p class="text-muted mb-4">Chỉ dành cho tài khoản có quyền quản trị.</p>

      <form
        id="adminLoginForm"
        method="post"
        action="{{ (BASE_API_URL or '') + '/api/auth/login_admin' }}"
      >
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input name="email" type="email" class="form-control" required />
        </div>

        <div class="mb-2">
          <label class="form-label">Mật khẩu</label>
          <div class="input-group">
            <input
              name="password"
              id="pass"
              type="password"
              class="form-control"
              required
            />
            <button
              class="btn btn-outline-secondary"
              type="button"
              id="togglePass"
            >
              <i class="bi bi-eye"></i>
            </button>
          </div>
        </div>

        <div id="msg" class="mt-3" style="display: none"></div>

        <button id="btnAdminLogin" class="btn btn-primary w-100" type="submit">
          Đăng nhập Admin
        </button>
      </form>

      <div class="text-center mt-3">
        <a class="small" href="/login">Đăng nhập khu người dùng</a>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // toggle pass
  document.getElementById("togglePass")?.addEventListener("click", () => {
    const ip = document.getElementById("pass");
    ip.type = ip.type === "password" ? "text" : "password";
  });

  const form = document.getElementById("adminLoginForm");
  const btn = document.getElementById("btnAdminLogin");
  const msg = document.getElementById("msg");

  function showMsg(text, ok = false) {
    msg.style.display = "block";
    msg.className = "mt-3 alert " + (ok ? "alert-success" : "alert-danger");
    msg.textContent = text;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      email: fd.get("email"),
      password: fd.get("password"),
    };

    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "Đang đăng nhập...";

    try {
      const resp = await fetch(form.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.success) {
        showMsg(data.message || `Đăng nhập thất bại (HTTP ${resp.status})`);
      } else {
        // Lưu token + user
        localStorage.setItem("token_type", data.token_type || "Bearer");
        localStorage.setItem("access_token", data.access_token || "");
        localStorage.setItem("refresh_token", data.refresh_token || "");
        if (data.user) localStorage.setItem("user", JSON.stringify(data.user));

        // Chỉ cho admin
        if (!data.user || data.user.role !== "admin") {
          showMsg("Tài khoản này không phải admin.");
          return;
        }
        showMsg("Đăng nhập admin thành công! Đang chuyển...", true);
        setTimeout(() => (location.href = "/admin/dashboard"), 600);
      }
    } catch (err) {
      console.error(err);
      showMsg("Không thể kết nối tới máy chủ. Thử lại sau.");
    } finally {
      btn.disabled = false;
      btn.textContent = oldText;
    }
  });
</script>
{% endblock %}
