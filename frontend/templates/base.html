<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}SVFinance{% endblock %}</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker3.min.css"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/variables.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/app.css') }}"
    />

    <style>
      .dropdown-menu-noti {
        width: min(420px, 90vw);
        max-height: 60vh;
        overflow-y: auto;
        padding: 0;
      }
      .dropdown-menu-noti .section-head {
        padding: 0.75rem 1rem;
        background: #fff;
      }
      #notiList {
        padding: 0 !important;
      }
      .noti-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        width: 100%;
        margin: 0;
        border-radius: 0;
        cursor: pointer;
      }
      .noti-item + .noti-item {
        border-top: 1px solid var(--bs-border-color);
      }
      .noti-item:hover {
        filter: brightness(0.98);
      }
      .noti-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-top: 0.45rem;
      }
      .dot-yellow {
        background: #f59e0b;
      }
      .dot-red {
        background: #ef4444;
      }
      .dot-black {
        background: #111827;
      }
      .dot-grey {
        background: #9ca3af;
      }
      .noti-unread-yellow {
        background: var(--bs-warning-bg-subtle, #fff3cd);
      }
      .noti-unread-red {
        background: var(--bs-danger-bg-subtle, #f8d7da);
      }
      .noti-unread-over {
        background: var(--bs-secondary-bg, #f1f3f5);
      }
      .noti-read {
        background: #fff !important;
      }
    </style>

    {% block head %}{% endblock %}
  </head>

  <body>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        if (params.get("login_ok") === "1") {
          // Tạo alert bootstrap và chèn vào DOM
          const container = document.createElement("div");
          container.innerHTML = `
      <div class="alert alert-success alert-dismissible fade show m-3" role="alert" style="position:fixed;top:1rem;right:1rem;z-index:2000;min-width:240px;">
        Đăng nhập thành công!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
          document.body.appendChild(container);

          // Xóa param khỏi URL cho sạch (không reload trang)
          params.delete("login_ok");
          const cleanUrl =
            window.location.pathname +
            (params.toString() ? "?" + params.toString() : "") +
            window.location.hash;
          window.history.replaceState({}, "", cleanUrl);
        }
      })();
    </script>

    <!-- GUARD -->
    <script>
      (function () {
        // Flag cho phép tắt guard cho một số trang công khai (login, register...)
        const SKIP_ROLE_GUARD = {{ 'true' if (SKIP_ROLE_GUARD|default(false, true)) else 'false' }};
        if (SKIP_ROLE_GUARD) return;

        try {
          const path = location.pathname || "";

          // lấy user + token từ localStorage
          const uRaw = localStorage.getItem("user") || "null";
          const u = JSON.parse(uRaw);
          const token = localStorage.getItem("access_token");

          // Các trang không cần guard
          const isAuthPage =
            path.startsWith("/login") ||
            path.startsWith("/register") ||
            path.startsWith("/verify-otp/");
          const isPublicHome = path === "/";

          if (isAuthPage || isPublicHome) return;

          // Nếu chưa đăng nhập -> đá về /login
          if (!u || !token) {
            window.location.replace("/login");
            return;
          }

          // Nếu là admin mà đang ở khu user thường -> chuyển về admin dashboard
          if (u.role === "admin" && !path.startsWith("/admin")) {
            window.location.replace("/admin/dashboard");
            return;
          }

          // Nếu là user mà cố vào khu admin -> đuổi về dashboard user
          if (u.role !== "admin" && path.startsWith("/admin")) {
            window.location.replace("/dashboard");
            return;
          }
        } catch (err) {
          console.warn("Guard error:", err);
          // fallback an toàn
          window.location.replace("/login");
        }
      })();
    </script>

    {% include 'partials/_navbar.html' %}

    <div class="container-fluid">
      <div class="row">
        {% if not hide_sidebar %}
        <div class="col-md-3 col-lg-2 bg-light border-end vh-100 overflow-auto">
          {% include 'partials/_sidebar.html' %}
        </div>
        {% endif %}

        <div
          class="{% if not hide_sidebar %}col-md-9 col-lg-10{% else %}col-12{% endif %} p-4"
        >
          {% with messages = get_flashed_messages(with_categories=true) %} {% if
          messages %} {% for category, message in messages %}
          <div
            class="alert alert-{{ category }} alert-dismissible fade show"
            role="alert"
          >
            {{ message }}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock
          %}
        </div>
      </div>
    </div>

    {% include 'partials/_toast.html' %} {% include 'partials/_modals.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      window.BASE_API_URL = "{{ BASE_API_URL|default('', true) }}";
      window.FEATURE_FLAGS = {{ FEATURE_FLAGS|default({}, true)|tojson }};
    </script>

    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notify.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof BudgetNotify !== "undefined") BudgetNotify.render();
      });
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.vi.min.js"></script>

    {% block scripts %}{% endblock %}
  </body>
</html>
