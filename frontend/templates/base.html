<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}SVFinance{% endblock %}</title>

    <script>
      (function () {
        const KEY = "theme_pref";
        const pref = localStorage.getItem(KEY) || "auto";
        const resolve = (p) => {
          if (p === "light" || p === "dark") return p;
          return window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        };
        const applied = resolve(pref);
        document.documentElement.setAttribute("data-theme-pref", pref);
        document.documentElement.setAttribute("data-theme", applied);
        document.documentElement.setAttribute("data-bs-theme", applied);
        if (pref === "auto" && window.matchMedia) {
          const mq = window.matchMedia("(prefers-color-scheme: dark)");
          mq.addEventListener("change", (e) => {
            const next = e.matches ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", next);
            document.documentElement.setAttribute("data-bs-theme", next);
          });
        }
      })();
    </script>

    <script>
      window.BASE_API_URL = "{{ BASE_API_URL|default('', true) }}";
      window.FEATURE_FLAGS = {{ FEATURE_FLAGS|default({}, true)|tojson }};
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/variables.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/app.css') }}"
    />

    <style>
      .dropdown-menu-noti {
        width: min(420px, 90vw);
        max-height: 60vh;
        overflow-y: auto;
        padding: 0;
      }
      .dropdown-menu-noti .section-head {
        padding: 0.75rem 1rem;
        background: var(--surface);
        color: var(--text);
        border-bottom: 1px solid var(--border);
      }
      #notiList {
        padding: 0 !important;
      }
      .noti-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        width: 100%;
        margin: 0;
        border-radius: 0;
        cursor: pointer;
        background: var(--surface);
        color: var(--text);
      }
      .noti-item + .noti-item {
        border-top: 1px solid var(--border);
      }
      .noti-item:hover {
        filter: brightness(0.98);
      }
      .noti-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        margin-top: 0.45rem;
      }
      .dot-yellow {
        background: #f59e0b;
      }
      .dot-red {
        background: #ef4444;
      }
      .dot-black {
        background: #111827;
      }
      .dot-grey {
        background: #9ca3af;
      }
      .noti-unread-yellow {
        background: rgba(245, 158, 11, 0.12);
      }
      .noti-unread-red {
        background: rgba(239, 68, 68, 0.12);
      }
      .noti-unread-over {
        background: var(--surface-2);
      }
      .noti-read {
        background: var(--surface) !important;
      }
    </style>

    {% block head %}{% endblock %}
  </head>

  <body>
    <script>
      (function () {
        if (window.DEMO_MODE) return; /* [FIX] DEMO -> bỏ qua guard */
        const SKIP_ROLE_GUARD = {{ 'true' if (SKIP_ROLE_GUARD|default(false, true)) else 'false' }};
        if (SKIP_ROLE_GUARD) return;
        try {
          const u = JSON.parse(localStorage.getItem("user") || "null");
          const t = localStorage.getItem("access_token");
          const path = location.pathname || "";
          const isAuthPage = path.startsWith("/login") || path.startsWith("/register");
          if (isAuthPage) return;
          if (!u || !t) { location.replace("/login"); return; }
          if (u.role === "admin" && !path.startsWith("/admin")) location.replace("/admin/dashboard");
        } catch (e) { console.warn("Guard error:", e); }
      })();
    </script>

    {% include 'partials/_navbar.html' %}

    <div class="d-flex w-100">
      {% if not hide_sidebar %}
      <div
        class="app-sidebar border-end vh-100 overflow-y-auto bg-white sticky-top"
        style="top: 56px; z-index: 100"
      >
        {% include 'partials/_sidebar.html' %}
      </div>
      {% endif %}

      <div class="flex-grow-1 p-4" style="min-width: 0">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock %}
      </div>
    </div>

    {% include 'partials/_toast.html' %} {% include 'partials/_modals.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script
      type="module"
      src="{{ url_for('static', filename='js/api.js') }}"
    ></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/notify.js') }}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("btnToggleSidebar");
        const body = document.body;
        const STATE_KEY = "sidebar_state";

        // 1. Kiểm tra trạng thái cũ từ LocalStorage
        const savedState = localStorage.getItem(STATE_KEY);
        if (savedState === "collapsed") {
          body.classList.add("sb-collapsed");
        }

        // 2. Sự kiện click
        if (btn) {
          btn.addEventListener("click", function () {
            body.classList.toggle("sb-collapsed");

            // Lưu lại trạng thái mới
            if (body.classList.contains("sb-collapsed")) {
              localStorage.setItem(STATE_KEY, "collapsed");
            } else {
              localStorage.setItem(STATE_KEY, "expanded");
            }
          });
        }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof BudgetNotify !== "undefined") BudgetNotify.render();
      });
    </script>

    {% block scripts %}{% endblock %} {# [CHATBOT-ADD] Chỉ hiển thị nếu bật cờ
    'ai' #} {% include 'partials/_chatbot.html' %}
  </body>
</html>
