<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}SVFinance{% endblock %}</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/variables.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/app.css') }}"
    />
    {% block head %}{% endblock %}
  </head>

  <body>
    <!-- ===== GUARD: chỉ dành cho khu USER =====
         - Nếu chưa đăng nhập → /login
         - Nếu là admin → chuyển sang /admin/dashboard
         - Có thể tắt bằng SKIP_ROLE_GUARD=True khi render -->
    <script>
      (function () {
        // Flag do server truyền vào; mặc định false nếu không set
        const SKIP_ROLE_GUARD = {{ 'true' if (SKIP_ROLE_GUARD|default(false, true)) else 'false' }};
        if (SKIP_ROLE_GUARD) return;

        try {
          const u = JSON.parse(localStorage.getItem("user") || "null");
          const t = localStorage.getItem("access_token");
          const path = location.pathname || "";

          // Bỏ qua guard cho trang auth (phòng khi base.html tái dùng nhầm)
          const isAuthPage = path.startsWith("/login") || path.startsWith("/register");
          if (isAuthPage) return;

          // Chưa đăng nhập -> về /login
          if (!u || !t) {
            location.replace("/login");
            return;
          }

          // Admin không được vào khu user -> đẩy qua admin dashboard
          if (u.role === "admin" && !path.startsWith("/admin")) {
            location.replace("/admin/dashboard");
          }
        } catch (e) {
          // an toàn nếu localStorage lỗi
          console.warn("Guard error:", e);
        }
      })();
    </script>

    {% include 'partials/_navbar.html' %}

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 bg-light border-end vh-100 overflow-auto">
          {% include 'partials/_sidebar.html' %}
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 p-4">
          {% with messages = get_flashed_messages(with_categories=true) %} {% if
          messages %} {% for category, message in messages %}
          <div
            class="alert alert-{{ category }} alert-dismissible fade show"
            role="alert"
          >
            {{ message }}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock
          %}
        </div>
      </div>
    </div>

    {% include 'partials/_toast.html' %} {% include 'partials/_modals.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      window.BASE_API_URL = "{{ BASE_API_URL|default('', true) }}";
      window.FEATURE_FLAGS = {{ FEATURE_FLAGS|default({}, true)|tojson }};
    </script>

    <!-- Lưu ý: base.html thuộc khu user; ở đây có thể dùng api.js nếu là non-module hoặc đã build bundler -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    {% block scripts %}{% endblock %}
  </body>
</html>
