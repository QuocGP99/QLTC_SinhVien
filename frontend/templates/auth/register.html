<!-- frontend/templates/auth/register.html -->
{% extends 'base_auth.html' %} {% block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
{% endblock %} {% block content %} {% set API = BASE_API_URL|default('', true)
%}
<div class="auth-page">
  <div
    class="auth-hero"
    style="background-image:url('{{ url_for('static', filename='img/auth-side.png') }}')"
  ></div>

  <div class="auth-form">
    <div class="auth-card card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">
        <h1 class="h4 mb-1">Tạo tài khoản</h1>
        <p class="text-muted mb-4">Mô tả thông tin của bạn</p>

        <!-- FORM -->
        <form id="registerForm" method="post">
          <div class="mb-3">
            <label class="form-label">Tên của bạn</label>
            <input name="full_name" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input name="email" type="email" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Nhập mật khẩu</label>
            <div class="input-group">
              <input
                name="password"
                id="regPass"
                type="password"
                class="form-control"
                minlength="6"
                required
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Nhập lại mật khẩu</label>
            <div class="input-group">
              <input
                name="confirm_password"
                id="regPass2"
                type="password"
                class="form-control"
                minlength="6"
                required
              />
            </div>
          </div>

          <!-- Chỗ hiển thị thông báo -->
          <div id="msg" class="mt-3" style="display: none"></div>

          <p class="small text-muted mt-2">
            Bằng cách đăng ký, tôi đồng ý với <a href="#">các điều khoản</a> &
            <a href="#">quyền riêng tư</a>.
          </p>

          <button id="btnSubmit" class="btn btn-primary w-100 mb-2">
            Tạo tài khoản
          </button>

          <!-- Giữ NGUYÊN nút Google của bạn -->
          <button class="btn btn-dark w-100" type="button" id="btnGoogle">
            <i class="bi bi-google me-2"></i>Đăng ký với Google
          </button>
        </form>

        <div class="text-center mt-3">
          <span class="text-muted">Đã có tài khoản?</span>
          <a href="/login">Đăng nhập</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  const API_BASE = "{{ API }}";
  const GOOGLE_CLIENT_ID = "{{ GOOGLE_CLIENT_ID|default('', true) }}"; // truyền từ web.py

  // Toggle hiển/ẩn mật khẩu
  const bindToggle = (inputId, btnId) => {
    document.getElementById(btnId)?.addEventListener("click", () => {
      const ip = document.getElementById(inputId);
      ip.type = ip.type === "password" ? "text" : "password";
    });
  };
  bindToggle("regPass", "toggleRegPass");
  bindToggle("regPass2", "toggleRegPass2");

  // Hiển thị thông báo
  const msg = document.getElementById("msg");
  function showMsg(text, ok = false) {
    msg.style.display = "block";
    msg.className = "mt-3 alert " + (ok ? "alert-success" : "alert-danger");
    msg.textContent = text;
  }

  // Submit đăng ký thường
  const form = document.getElementById("registerForm");
  const btn = document.getElementById("btnSubmit");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fd = new FormData(form);
    const full_name = fd.get("full_name");
    const email = fd.get("email");
    const password = fd.get("password");
    const confirm_password = fd.get("confirm_password");

    if (password !== confirm_password) {
      showMsg("Mật khẩu nhập lại không khớp");
      return;
    }

    // payload gửi cho backend: KHÔNG gửi confirm_password
    const payload = {
      full_name,
      email,
      password,
    };

    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "Đang tạo tài khoản...";

    try {
      const resp = await fetch((API_BASE || "") + "/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      let data = {};
      try {
        data = await resp.json();
      } catch (_) {
        data = {};
      }

      console.log("[REGISTER] status:", resp.status, data);

      // Khi backend trả lỗi (ví dụ email đã tồn tại)
      if (!resp.ok || data.success === false) {
        showMsg(
          data.message ||
            (resp.status === 400
              ? "Email đã tồn tại hoặc dữ liệu không hợp lệ"
              : `Đăng ký thất bại (HTTP ${resp.status})`)
        );
        return;
      }

      // ---- THÀNH CÔNG ----
      // Lưu email tạm để OTP page có thể tự fill (nếu cần)
      localStorage.setItem("pending_email", email);

      // Ưu tiên redirect từ backend (đi tới trang /verify-otp/?email=...)
      if (data.redirect || data.redirect_url) {
        const nextUrl = data.redirect || data.redirect_url;
        console.log("[REGISTER] redirect to OTP:", nextUrl);
        window.location.href = nextUrl;
        return;
      }

      // Nếu backend không trả redirect (fallback)
      if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        if (data.user) {
          localStorage.setItem("user", JSON.stringify(data.user));
        }
        window.location.href = "/dashboard";
        return;
      }

      // fallback cuối cùng
      showMsg("Đăng ký thành công! Vui lòng kiểm tra email để xác thực.", true);
      setTimeout(() => {
        window.location.href = "/login";
      }, 800);
    } catch (err) {
      console.error("[REGISTER] error:", err);
      showMsg("Không thể kết nối tới máy chủ. Thử lại sau.");
    } finally {
      btn.disabled = false;
      btn.textContent = oldText;
    }
  });

  // ==== Google Sign-In (giữ nguyên button, mở One Tap/ Popup khi click) ====
  let googleReady = false;
  let googleInitialized = false;

  // Khởi tạo GIS (không render button mặc định)
  window.addEventListener("load", () => {
    googleReady = true;
    if (!GOOGLE_CLIENT_ID) return;
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: async ({ credential }) => {
        try {
          const resp = await fetch((API_BASE || "") + "/api/auth/google", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ credential }),
          });
          const data = await resp.json();
          if (!data.success) {
            showMsg(data.message || "Google Sign-in thất bại");
            return;
          }

          // OTP flow cho tài khoản Google mới (nếu backend buộc xác thực email)
          if (data.redirect || data.redirect_url) {
            const nextUrl = data.redirect || data.redirect_url;
            window.location.href = nextUrl;
            return;
          }

          // Đăng nhập thẳng
          localStorage.setItem("access_token", data.access_token || "");
          if (data.user) {
            localStorage.setItem("user", JSON.stringify(data.user));
          }
          window.location.href = "/dashboard";
        } catch (e) {
          console.error(e);
          showMsg("Lỗi Google Sign-in");
        }
      },
      ux_mode: "popup",
      use_fedcm_for_prompt: true,
    });
    googleInitialized = true;
  });

  // Khi bấm nút Google -> bật chọn tài khoản Google
  document.getElementById("btnGoogle")?.addEventListener("click", () => {
    if (!GOOGLE_CLIENT_ID) {
      showMsg("Chưa cấu hình GOOGLE_CLIENT_ID trên server.");
      return;
    }
    if (!googleReady || !googleInitialized || !window.google?.accounts?.id) {
      showMsg("Google chưa sẵn sàng, thử lại trong giây lát.");
      return;
    }
    google.accounts.id.prompt();
  });
</script>
{% endblock %}
