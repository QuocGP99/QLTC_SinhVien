{% extends 'base_auth.html' %} {% block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
{% endblock %} {% block content %}
<div class="auth-page">
  <div
    class="auth-hero"
    style="background-image:url('{{ url_for('static', filename='img/auth-side.jpg') }}')"
  ></div>
  <div class="auth-form">
    <div class="auth-card card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">
        <h1 class="h4 mb-1">Create an account</h1>
        <p class="text-muted mb-4">Provide your details.</p>

        <!-- FORM -->
        <form
          id="registerForm"
          method="post"
          action="{{ api_base }}/api/auth/register"
        >
          <div class="mb-3">
            <label class="form-label">Your name</label>
            <input name="full_name" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input name="email" type="email" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Password</label>
            <div class="input-group">
              <input
                name="password"
                id="regPass"
                type="password"
                class="form-control"
                minlength="6"
                required
              />
              <button
                class="btn btn-outline-secondary"
                type="button"
                id="toggleRegPass"
              >
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          <!-- Chỗ hiển thị thông báo -->
          <div id="msg" class="mt-3" style="display: none"></div>

          <p class="small text-muted mt-2">
            By signing up I agree to the <a href="#">terms</a> &
            <a href="#">privacy</a>.
          </p>

          <button id="btnSubmit" class="btn btn-primary w-100 mb-2">
            Create An Account
          </button>
          <button class="btn btn-dark w-100" type="button">
            <i class="bi bi-google me-2"></i>Register with Google
          </button>
        </form>

        <div class="text-center mt-3">
          <span class="text-muted">Already a Member?</span>
          <a href="/login">Sign In</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  // Toggle hiển thị mật khẩu
  document.getElementById("toggleRegPass")?.addEventListener("click", () => {
    const ip = document.getElementById("regPass");
    ip.type = ip.type === "password" ? "text" : "password";
  });

  // AJAX submit
  const form = document.getElementById("registerForm");
  const btn = document.getElementById("btnSubmit");
  const msg = document.getElementById("msg");

  function showMsg(text, ok = false) {
    msg.style.display = "block";
    msg.className = "mt-3 alert " + (ok ? "alert-success" : "alert-danger");
    msg.textContent = text;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Gom dữ liệu
    const fd = new FormData(form);
    const payload = {
      full_name: fd.get("full_name"),
      email: fd.get("email"),
      password: fd.get("password"),
    };

    // Disable nút khi đang gửi
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "Đang tạo tài khoản...";

    try {
      const resp = await fetch(form.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.success) {
        showMsg(
          data.message || `Đăng ký thất bại (HTTP ${resp.status})`,
          false
        );
      } else {
        showMsg("Đăng ký thành công! Vui lòng đăng nhập.", true);
        // chuyển sau 1 giây
        setTimeout(() => {
          window.location.href = "/login";
        }, 1000);
      }
    } catch (err) {
      console.error(err);
      showMsg("Không thể kết nối tới máy chủ. Thử lại sau.", false);
    } finally {
      btn.disabled = false;
      btn.textContent = oldText;
    }
  });
</script>
{% endblock %}
