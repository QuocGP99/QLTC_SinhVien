{% extends 'base_auth.html' %} {% block head %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
<style>
  /* KHÔNG chặn reveal button mặc định của Edge/Chrome */
  /* => Không thêm bất cứ rule ẩn ::-ms-reveal nào nữa */

  /* Chỉnh một chút cho form nhìn gọn */
  .input-group.no-addon .form-control {
    border-top-right-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
  }
</style>
{% endblock %} {% block content %} {% set API = BASE_API_URL|default('', true)
%}
<div class="auth-page">
  <div
    class="auth-hero"
    style="background-image:url('{{ url_for('static', filename='img/auth-side.png') }}')"
  ></div>

  <div class="auth-form">
    <div class="auth-card card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">
        <h1 class="h4 mb-1">
          {% if ADMIN_MODE %} Đăng nhập Quản trị {% else %} Chào mừng bạn trở
          lại! {% endif %}
        </h1>

        <p class="text-muted mb-2">
          {% if ADMIN_MODE %} Đây là
          <strong>trang đăng nhập dành cho Admin</strong>. Vui lòng sử dụng tài
          khoản có quyền quản trị. {% else %} Theo dõi tài chính cá nhân của bạn
          với <strong>SVFinance</strong>. {% endif %}
        </p>

        {% if ADMIN_MODE %}
        <div class="mb-3">
          <span class="badge rounded-pill text-bg-warning">
            <i class="bi bi-shield-lock me-1"></i> Admin Only
          </span>
        </div>
        {% endif %}

        <!-- Form login -->
        <form id="loginForm" method="post" novalidate>
          <div class="mb-3">
            <label class="form-label">Nhập Email</label>
            <input name="email" type="email" class="form-control" required />
          </div>

          <div class="mb-2">
            <label class="form-label">Nhập mật khẩu</label>
            <!-- KHÔNG còn button/icon mắt tùy chỉnh -->
            <input
              name="password"
              id="loginPass"
              type="password"
              class="form-control"
              required
            />
          </div>

          <div class="d-flex justify-content-between mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="remember" />
              <label class="form-check-label" for="remember">
                Ghi nhớ mật khẩu
              </label>
            </div>
            <a href="/forgot" class="small">Bạn quên mật khẩu?</a>
          </div>

          <button
            id="btnLogin"
            class="btn btn-primary w-100 mb-2"
            type="submit"
          >
            {% if ADMIN_MODE %}Đăng nhập Admin{% else %}Đăng nhập{% endif %}
          </button>

          <button
            class="btn btn-dark w-100 {% if ADMIN_MODE %}d-none{% endif %}"
            type="button"
            id="btnGoogle"
          >
            <i class="bi bi-google me-2"></i>Tiếp tục với Google
          </button>

          <div id="msg" style="display: none"></div>
        </form>

        {% if not ADMIN_MODE %}
        <div class="text-center mt-3">
          <span class="text-muted">Bạn chưa có tài khoản?</span>
          <a href="/register">Tạo tài khoản</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Form ẩn cho Microsoft Password Manager -->
<form
  id="loginFormReal"
  action="/api/auth/login_form"
  method="POST"
  style="display: none"
>
  <input type="email" name="email" id="realEmail" />
  <input type="password" name="password" id="realPass" />
</form>

<!-- Modal xác nhận lưu mật khẩu -->
<div class="modal fade" id="rememberModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 16px">
      <div class="modal-header">
        <h5 class="modal-title">Lưu mật khẩu?</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        Bạn chắc chắn muốn lưu mật khẩu cho lần đăng nhập sau chứ?
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          id="rememberNo"
          data-bs-dismiss="modal"
        >
          Không
        </button>
        <button type="button" class="btn btn-primary" id="rememberYes">
          Có, lưu mật khẩu
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const API = "{{ BASE_API_URL|default('', true) }}";

    // refs
    const form = document.getElementById("loginForm");
    const emailInput = form.querySelector('input[name="email"]');
    const passInput = form.querySelector('input[name="password"]');
    const rememberCb = document.getElementById("remember");
    const btnLogin = document.getElementById("btnLogin");
    const msg = document.getElementById("msg");

    const modalEl = document.getElementById("rememberModal");
    const modalYesBtn = document.getElementById("rememberYes");
    const modalNoBtn = document.getElementById("rememberNo");

    const loginFormReal = document.getElementById("loginFormReal");
    const realEmail = document.getElementById("realEmail");
    const realPass = document.getElementById("realPass");

    function showMsg(text, ok = false) {
      msg.style.display = "block";
      msg.className = "alert mt-3 " + (ok ? "alert-success" : "alert-danger");
      msg.textContent = text;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();
      const password = passInput.value.trim();

      if (!email || !password) {
        showMsg("Vui lòng nhập email và mật khẩu");
        return;
      }

      btnLogin.disabled = true;
      const oldText = btnLogin.textContent;
      btnLogin.textContent = "Đang đăng nhập...";

      try {
        const resp = await fetch((API || "") + "/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            password,
            remember: !!rememberCb?.checked,
          }),
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || !data.success) {
          showMsg(data.message || "Đăng nhập thất bại");
          return;
        }

        // lưu session token / user
        localStorage.setItem("token_type", data.token_type || "Bearer");
        localStorage.setItem("access_token", data.access_token || "");
        if (data.user) {
          localStorage.setItem("user", JSON.stringify(data.user));
        }

        // Nếu không tick nhớ mật khẩu -> đi thẳng
        if (!rememberCb.checked) {
          showMsg("Đăng nhập thành công! Đang chuyển...", true);
          setTimeout(
            () => (window.location.href = "/dashboard?login_ok=1"),
            400
          );
          return;
        }

        // Nếu tick -> hỏi Edge/Chrome lưu
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        modalNoBtn.onclick = () => {
          rememberCb.checked = false;
          showMsg("Đăng nhập thành công! Đang chuyển...", true);
          setTimeout(
            () => (window.location.href = "/dashboard?login_ok=1"),
            400
          );
        };

        modalYesBtn.onclick = () => {
          realEmail.value = email;
          realPass.value = password;
          loginFormReal.submit(); // submit form truyền thống -> Edge gọi Save Password
        };
      } catch (err) {
        console.error(err);
        showMsg("Không thể kết nối máy chủ");
      } finally {
        btnLogin.disabled = false;
        btnLogin.textContent = oldText;
      }
    });

    // Google login placeholder
    document.getElementById("btnGoogle")?.addEventListener("click", () => {
      alert(
        "Tính năng đăng nhập Google sẽ sớm bật lại. Hiện tại dùng email/mật khẩu nhé."
      );
    });
  });
</script>
{% endblock %}
