{% extends "base_auth.html" %} {% block title %}Xác thực email{% endblock %} {%
block content %}
<div
  class="min-vh-100 d-flex align-items-center justify-content-center bg-gradient"
  style="background: linear-gradient(135deg, #6a5af9, #805ad5)"
>
  <div
    class="card shadow-lg border-0"
    style="max-width: 560px; border-radius: 20px"
  >
    <div class="card-body p-4 p-md-5 text-center">
      <div
        class="mx-auto mb-3"
        style="
          width: 72px;
          height: 72px;
          border-radius: 50%;
          background: #f1efff;
          display: grid;
          place-items: center;
        "
      >
        <i
          class="bi bi-envelope-fill"
          style="font-size: 28px; color: #6a5af9"
        ></i>
      </div>

      <h5 class="fw-bold mb-2">Verify Your Email</h5>
      <p class="text-muted mb-4">
        Please enter the 6-digit verification code we sent to
        <span class="fw-semibold">{{ email or '' }}</span>
      </p>

      <!-- OTP inputs -->
      <form
        id="otpForm"
        class="d-flex justify-content-center gap-2 mb-3"
        autocomplete="one-time-code"
      >
        {% for i in range(6) %}
        <input
          class="otp-input form-control text-center"
          inputmode="numeric"
          pattern="[0-9]*"
          maxlength="1"
          style="
            width: 56px;
            height: 56px;
            border-radius: 12px;
            font-size: 20px;
          "
        />
        {% endfor %}
      </form>

      <!-- actions -->
      <button
        id="btnConfirm"
        class="btn btn-primary w-100 py-2 fw-semibold"
        disabled
        style="background: #6a5af9; border: none; border-radius: 12px"
      >
        Confirm
      </button>

      <div class="mt-3 small">
        <span id="countdown" class="text-muted">Gửi lại mã sau 60s</span>
        <button id="btnResend" class="btn btn-link p-0 ms-2" disabled>
          Gửi lại mã
        </button>
      </div>

      <div
        id="otpAlert"
        class="alert alert-danger mt-3 d-none"
        role="alert"
      ></div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  (function () {
    const API = "{{ BASE_API_URL|default('', true) }}";
    const inputs = Array.from(document.querySelectorAll(".otp-input"));
    const confirm = document.getElementById("btnConfirm");
    const resend = document.getElementById("btnResend");
    const alertEl = document.getElementById("otpAlert");
    const countdown = document.getElementById("countdown");

    // lấy email từ server (nếu có) hoặc query/localStorage
    const email =
      "{{ email or '' }}".trim() ||
      new URLSearchParams(location.search).get("email") ||
      localStorage.getItem("pending_email") ||
      "";

    // focus ô đầu
    inputs[0].focus();

    // helper
    const getCode = () => inputs.map((i) => i.value).join("");
    const setBtnState = () => {
      confirm.disabled = getCode().length !== 6;
    };

    // auto-move, chỉ cho số
    inputs.forEach((inp, idx) => {
      inp.addEventListener("input", (e) => {
        let v = e.target.value.replace(/\D/g, "");
        e.target.value = v.slice(0, 1);
        if (v && idx < inputs.length - 1) inputs[idx + 1].focus();
        setBtnState();
      });
      inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !inp.value && idx > 0) {
          inputs[idx - 1].focus();
          inputs[idx - 1].value = "";
          e.preventDefault();
        }
        if (e.key === "ArrowLeft" && idx > 0) inputs[idx - 1].focus();
        if (e.key === "ArrowRight" && idx < inputs.length - 1)
          inputs[idx + 1].focus();
        if (e.key === "Enter" && !confirm.disabled) submitCode();
      });
      // paste 6 số cùng lúc
      inp.addEventListener("paste", (e) => {
        const text = (e.clipboardData || window.clipboardData)
          .getData("text")
          .replace(/\D/g, "")
          .slice(0, 6);
        if (!text) return;
        e.preventDefault();
        inputs.forEach((i, k) => (i.value = text[k] || ""));
        inputs[Math.min(text.length, 5)].focus();
        setBtnState();
      });
    });

    // countdown 60s cho resend
    let remain = 60,
      timer = null;
    function startTimer() {
      resend.disabled = true;
      timer && clearInterval(timer);
      countdown.textContent = `Gửi lại mã sau ${remain}s`;
      timer = setInterval(() => {
        remain--;
        if (remain <= 0) {
          clearInterval(timer);
          countdown.textContent = "Bạn có thể gửi lại mã.";
          resend.disabled = false;
        } else {
          countdown.textContent = `Gửi lại mã sau ${remain}s`;
        }
      }, 1000);
    }
    startTimer();

    resend.addEventListener("click", async () => {
      remain = 60;
      startTimer();
      alertEl.classList.add("d-none");
      inputs.forEach((i) => (i.value = ""));
      inputs[0].focus();
      setBtnState();

      await fetch((API || "") + "/api/auth/resend-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
      });
    });

    confirm.addEventListener("click", submitCode);

    async function submitCode() {
      const code = getCode();
      if (code.length !== 6) return;

      confirm.disabled = true;
      alertEl.classList.add("d-none");

      try {
        const res = await fetch((API || "") + "/api/auth/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code }),
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.message || "OTP không hợp lệ");
        }

        // Lưu token nếu backend trả
        if (data.access_token) {
          localStorage.setItem("access_token", data.access_token);
        }
        if (data.user) localStorage.setItem("user", JSON.stringify(data.user));

        window.location.href = "/dashboard"; // hoặc "/"
      } catch (err) {
        alertEl.textContent = err.message || "Có lỗi xảy ra, vui lòng thử lại.";
        alertEl.classList.remove("d-none");
        confirm.disabled = false;
      }
    }
  })();
</script>
{% endblock %}
