{% extends "base_auth.html" %} {% block title %}XÃ¡c thá»±c email{% endblock %} {%
block content %}
<div
  class="min-vh-100 d-flex align-items-center justify-content-center bg-gradient"
  style="background: linear-gradient(135deg, #6a5af9, #805ad5)"
>
  <div
    class="card shadow-lg border-0"
    style="max-width: 560px; border-radius: 20px"
  >
    <div class="card-body p-4 p-md-5 text-center">
      <div
        class="mx-auto mb-3"
        style="
          width: 72px;
          height: 72px;
          border-radius: 50%;
          background: #f1efff;
          display: grid;
          place-items: center;
        "
      >
        <i
          class="bi bi-envelope-fill"
          style="font-size: 28px; color: #6a5af9"
        ></i>
      </div>

      <!-- ============ STATE 1: thÃ´ng bÃ¡o ban Ä‘áº§u + nÃºt má»Ÿ form ============ -->
      <div id="stateInfo">
        <h5 class="fw-bold mb-2">Vui lÃ²ng kiá»ƒm tra Gmail ðŸ“©</h5>
        <p class="text-muted mb-3">
          ChÃºng tÃ´i Ä‘Ã£ gá»­i mÃ£ xÃ¡c thá»±c 6 sá»‘ Ä‘áº¿n
          <span class="fw-semibold">{{ email or '' }}</span>.<br />
          Nháº¥n nÃºt bÃªn dÆ°á»›i Ä‘á»ƒ nháº­p mÃ£ OTP.
        </p>

        <button
          id="btnShowForm"
          class="btn btn-primary w-100 py-2 fw-semibold"
          style="background: #6a5af9; border: none; border-radius: 12px"
        >
          Nháº­p mÃ£ OTP
        </button>

        <div class="mt-4 small">
          <span id="countdownInfo" class="text-muted"
            >Gá»­i láº¡i mÃ£ sau <span id="cdInfoSec">30</span>s</span
          >
          <button
            id="btnResendInfo"
            class="btn btn-link p-0 ms-2"
            disabled
            style="vertical-align: baseline"
          >
            Gá»­i láº¡i mÃ£
          </button>
        </div>
      </div>

      <!-- ============ STATE 2: form nháº­p OTP (áº©n ban Ä‘áº§u) ============ -->
      <div id="stateForm" style="display: none">
        <h5 class="fw-bold mb-2">Nháº­p mÃ£ OTP</h5>
        <p class="text-muted mb-3">
          Nháº­p 6 sá»‘ Ä‘Ã£ gá»­i Ä‘áº¿n
          <span class="fw-semibold">{{ email or '' }}</span>
        </p>

        <form id="otpForm" class="mb-3" autocomplete="one-time-code">
          <input
            id="otpInput"
            class="form-control text-center"
            inputmode="numeric"
            autocomplete="one-time-code"
            placeholder="______"
            maxlength="6"
            style="
              font-size: 24px;
              font-weight: 600;
              letter-spacing: 0.6rem;
              text-align: center;
              border-radius: 12px;
            "
          />
        </form>

        <button
          id="btnConfirm"
          class="btn btn-success w-100 py-2 fw-semibold"
          disabled
          style="border: none; border-radius: 12px"
        >
          XÃ¡c nháº­n OTP
        </button>

        <div class="mt-3 small">
          <span id="countdownForm" class="text-muted"
            >Gá»­i láº¡i mÃ£ sau <span id="cdFormSec">30</span>s</span
          >
          <button
            id="btnResendForm"
            class="btn btn-link p-0 ms-2"
            disabled
            style="vertical-align: baseline"
          >
            Gá»­i láº¡i mÃ£
          </button>
        </div>

        <div
          id="otpAlert"
          class="alert mt-3 d-none"
          role="alert"
          style="border-radius: 12px; text-align: left"
        ></div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  (function () {
    const API = "{{ BASE_API_URL|default('', true) }}";
    const email =
      "{{ email or '' }}".trim() ||
      new URLSearchParams(location.search).get("email") ||
      localStorage.getItem("pending_email") ||
      "";

    // DOM refs
    const stateInfo = document.getElementById("stateInfo");
    const stateForm = document.getElementById("stateForm");
    const btnShowForm = document.getElementById("btnShowForm");

    const otpInput = document.getElementById("otpInput");
    const otpForm = document.getElementById("otpForm");
    const btnConfirm = document.getElementById("btnConfirm");
    const otpAlert = document.getElementById("otpAlert");

    // resend buttons + countdown
    const btnResendInfo = document.getElementById("btnResendInfo");
    const countdownInfo = document.getElementById("countdownInfo");
    const cdInfoSec = document.getElementById("cdInfoSec");

    const btnResendForm = document.getElementById("btnResendForm");
    const countdownForm = document.getElementById("countdownForm");
    const cdFormSec = document.getElementById("cdFormSec");

    // ========== 1. BUG "gÃµ 1 sá»‘ ra 2 sá»‘" FIX ==========
    // ChÃºng ta dÃ¹ng 1 Ã´ input duy nháº¥t, khÃ´ng cÃ²n 6 Ã´ auto-focus ná»¯a.
    // Chá»‰ cho phÃ©p sá»‘, cáº¯t cÃ²n 6 sá»‘. KhÃ´ng inject láº¡i giÃ¡ trá»‹ -> khÃ´ng nhÃ¢n Ä‘Ã´i.
    otpInput?.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D+/g, "");
      if (v.length > 6) v = v.slice(0, 6);
      e.target.value = v;

      btnConfirm.disabled = v.length !== 6;
    });

    // enter Ä‘á»ƒ submit
    otpInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !btnConfirm.disabled) {
        submitCode();
      }
    });

    // ========== 2. Hiá»ƒn thá»‹ form chá»‰ khi user click "Nháº­p mÃ£ OTP" ==========
    btnShowForm.addEventListener("click", () => {
      stateInfo.style.display = "none";
      stateForm.style.display = "block";
      otpInput.focus();
    });

    // ========== 3. Verify OTP ==========
    btnConfirm.addEventListener("click", submitCode);

    async function submitCode() {
      const code = otpInput.value.trim();
      if (code.length !== 6) return;

      btnConfirm.disabled = true;
      showAlert("", null); // clear alert

      try {
        const res = await fetch((API || "") + "/api/auth/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code }),
        });

        const data = await res.json().catch(() => ({}));

        // OTP Ä‘Ãºng
        if (res.ok && data && data.success) {
          showAlert("XÃ¡c thá»±c thÃ nh cÃ´ng! Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p.", true);

          // ÄÃ¡nh dáº¥u user Ä‘Ã£ verify (tuá»³ backend báº¡n cÃ³ tráº£ access_token/user hay khÃ´ng)
          if (data.access_token) {
            localStorage.setItem("access_token", data.access_token);
          }
          if (data.user) {
            localStorage.setItem("user", JSON.stringify(data.user));
          }

          // chuyá»ƒn qua /login sau 1s
          setTimeout(() => {
            window.location.href = "/login";
          }, 1000);

          return;
        }

        // OTP sai / háº¿t háº¡n
        showAlert(
          data.message ||
            "MÃ£ OTP khÃ´ng há»£p lá»‡ hoáº·c Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng thá»­ láº¡i.",
          false
        );
        otpInput.value = "";
        otpInput.focus();
        btnConfirm.disabled = true;
      } catch (err) {
        console.error("verify-otp error:", err);
        showAlert("Lá»—i káº¿t ná»‘i mÃ¡y chá»§. Vui lÃ²ng thá»­ láº¡i.", false);
        otpInput.focus();
      } finally {
        // Cho phÃ©p nháº­p láº¡i
        btnConfirm.disabled = otpInput.value.trim().length !== 6;
      }
    }

    function showAlert(msg, ok) {
      if (!msg) {
        otpAlert.classList.add("d-none");
        otpAlert.textContent = "";
        return;
      }
      otpAlert.classList.remove("d-none", "alert-danger", "alert-success");
      otpAlert.classList.add(ok ? "alert-success" : "alert-danger");
      otpAlert.textContent = msg;
    }

    // ========== 4. Cooldown resend OTP 30s ==========
    // YÃªu cáº§u cá»§a báº¡n:
    // - Vá»«a vÃ o trang: nÃºt resend bá»‹ disable, cÃ³ Ä‘áº¿m ngÆ°á»£c 30s
    // - Háº¿t 30s -> enable cáº£ 2 nÃºt resend
    // - Khi nháº¥n resend -> gá»i /api/auth/resend-otp rá»“i reset countdown 30s ná»¯a

    let remain = 30;
    let timer = null;

    function updateCountdownUI() {
      cdInfoSec.textContent = remain;
      cdFormSec.textContent = remain;
    }

    function setResendEnabled(enabled) {
      btnResendInfo.disabled = !enabled;
      btnResendForm.disabled = !enabled;
      countdownInfo.style.display = enabled ? "none" : "inline";
      countdownForm.style.display = enabled ? "none" : "inline";

      if (enabled) {
        btnResendInfo.textContent = "Gá»­i láº¡i mÃ£";
        btnResendForm.textContent = "Gá»­i láº¡i mÃ£";
      } else {
        btnResendInfo.textContent = "Gá»­i láº¡i mÃ£";
        btnResendForm.textContent = "Gá»­i láº¡i mÃ£";
      }
    }

    function startCooldown() {
      remain = 30;
      setResendEnabled(false);
      updateCountdownUI();

      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        remain--;
        if (remain <= 0) {
          clearInterval(timer);
          setResendEnabled(true);
        } else {
          updateCountdownUI();
        }
      }, 1000);
    }

    async function resendOtp() {
      // báº­t cooldown láº¡i ngay khi báº¥m
      startCooldown();
      showAlert("", null); // clear alert

      try {
        const resp = await fetch((API || "") + "/api/auth/resend-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await resp.json().catch(() => ({}));

        if (!(resp.ok && data && data.success)) {
          // vÃ­ dá»¥ backend tráº£ 429 cooldown
          showAlert(
            data.message ||
              "KhÃ´ng thá»ƒ gá»­i láº¡i mÃ£ OTP lÃºc nÃ y. Vui lÃ²ng thá»­ láº¡i sau.",
            false
          );
          return;
        }

        // gá»­i láº¡i OK
        showAlert("ÄÃ£ gá»­i láº¡i mÃ£ OTP vÃ o email cá»§a báº¡n.", true);
      } catch (err) {
        console.error("resend-otp error:", err);
        showAlert("Lá»—i káº¿t ná»‘i khi gá»­i láº¡i mÃ£ OTP.", false);
      }
    }

    btnResendInfo.addEventListener("click", (e) => {
      e.preventDefault();
      if (btnResendInfo.disabled) return;
      resendOtp();
    });

    btnResendForm.addEventListener("click", (e) => {
      e.preventDefault();
      if (btnResendForm.disabled) return;
      resendOtp();
    });

    // Khá»Ÿi cháº¡y cooldown láº§n Ä‘áº§u khi load trang
    startCooldown();
  })();
</script>
{% endblock %}
