{% extends "base_auth.html" %} {% block title %}X√°c th·ª±c email{% endblock %} {%
block content %}
<div
  class="min-vh-100 d-flex align-items-center justify-content-center bg-gradient"
  style="background: linear-gradient(135deg, #6a5af9, #805ad5)"
>
  <div
    class="card shadow-lg border-0"
    style="max-width: 560px; border-radius: 20px"
  >
    <div class="card-body p-4 p-md-5 text-center">
      <div
        class="mx-auto mb-3"
        style="
          width: 72px;
          height: 72px;
          border-radius: 50%;
          background: #f1efff;
          display: grid;
          place-items: center;
        "
      >
        <i
          class="bi bi-envelope-fill"
          style="font-size: 28px; color: #6a5af9"
        ></i>
      </div>

      <!-- ============ STATE 1: th√¥ng b√°o ban ƒë·∫ßu + n√∫t m·ªü form ============ -->
      <div id="stateInfo">
        <h5 class="fw-bold mb-2">Vui l√≤ng ki·ªÉm tra Gmail üì©</h5>
        <p class="text-muted mb-3">
          Ch√∫ng t√¥i ƒë√£ g·ª≠i m√£ x√°c th·ª±c 6 s·ªë ƒë·∫øn
          <span class="fw-semibold">{{ email or '' }}</span>.<br />
          Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ nh·∫≠p m√£ OTP.
        </p>

        <button
          id="btnShowForm"
          class="btn btn-primary w-100 py-2 fw-semibold"
          style="background: #6a5af9; border: none; border-radius: 12px"
        >
          Nh·∫≠p m√£ OTP
        </button>

        <div class="mt-4 small">
          <span id="countdownInfo" class="text-muted"
            >G·ª≠i l·∫°i m√£ sau <span id="cdInfoSec">30</span>s</span
          >
          <button
            id="btnResendInfo"
            class="btn btn-link p-0 ms-2"
            disabled
            style="vertical-align: baseline"
          >
            G·ª≠i l·∫°i m√£
          </button>
        </div>
      </div>

      <!-- ============ STATE 2: form nh·∫≠p OTP (·∫©n ban ƒë·∫ßu) ============ -->
      <div id="stateForm" style="display: none">
        <h5 class="fw-bold mb-2">Nh·∫≠p m√£ OTP</h5>
        <p class="text-muted mb-3">
          Nh·∫≠p 6 s·ªë ƒë√£ g·ª≠i ƒë·∫øn
          <span class="fw-semibold">{{ email or '' }}</span>
        </p>

        <form id="otpForm" class="mb-3" autocomplete="one-time-code">
          <input
            id="otpInput"
            class="form-control text-center"
            inputmode="numeric"
            autocomplete="one-time-code"
            placeholder="______"
            maxlength="6"
            style="
              font-size: 24px;
              font-weight: 600;
              letter-spacing: 0.6rem;
              text-align: center;
              border-radius: 12px;
            "
          />
        </form>

        <button
          id="btnConfirm"
          class="btn btn-success w-100 py-2 fw-semibold"
          disabled
          style="border: none; border-radius: 12px"
        >
          X√°c nh·∫≠n OTP
        </button>

        <div class="mt-3 small">
          <span id="countdownForm" class="text-muted"
            >G·ª≠i l·∫°i m√£ sau <span id="cdFormSec">30</span>s</span
          >
          <button
            id="btnResendForm"
            class="btn btn-link p-0 ms-2"
            disabled
            style="vertical-align: baseline"
          >
            G·ª≠i l·∫°i m√£
          </button>
        </div>

        <div
          id="otpAlert"
          class="alert mt-3 d-none"
          role="alert"
          style="border-radius: 12px; text-align: left"
        ></div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  (function () {
    const API = "{{ BASE_API_URL|default('', true) }}";
    const email =
      "{{ email or '' }}".trim() ||
      new URLSearchParams(location.search).get("email") ||
      localStorage.getItem("pending_email") ||
      "";

    // DOM refs
    const stateInfo = document.getElementById("stateInfo");
    const stateForm = document.getElementById("stateForm");
    const btnShowForm = document.getElementById("btnShowForm");

    const otpInput = document.getElementById("otpInput");
    const otpForm = document.getElementById("otpForm");
    const btnConfirm = document.getElementById("btnConfirm");
    const otpAlert = document.getElementById("otpAlert");

    // resend buttons + countdown
    const btnResendInfo = document.getElementById("btnResendInfo");
    const countdownInfo = document.getElementById("countdownInfo");
    const cdInfoSec = document.getElementById("cdInfoSec");

    const btnResendForm = document.getElementById("btnResendForm");
    const countdownForm = document.getElementById("countdownForm");
    const cdFormSec = document.getElementById("cdFormSec");

    // ========== 1. BUG "g√µ 1 s·ªë ra 2 s·ªë" FIX ==========
    // Ch√∫ng ta d√πng 1 √¥ input duy nh·∫•t, kh√¥ng c√≤n 6 √¥ auto-focus n·ªØa.
    // Ch·ªâ cho ph√©p s·ªë, c·∫Øt c√≤n 6 s·ªë. Kh√¥ng inject l·∫°i gi√° tr·ªã -> kh√¥ng nh√¢n ƒë√¥i.
    otpInput?.addEventListener("input", (e) => {
      let v = e.target.value.replace(/\D+/g, "");
      if (v.length > 6) v = v.slice(0, 6);
      e.target.value = v;

      btnConfirm.disabled = v.length !== 6;
    });

    // enter ƒë·ªÉ submit
    otpInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !btnConfirm.disabled) {
        submitCode();
      }
    });

    // ========== 2. Hi·ªÉn th·ªã form ch·ªâ khi user click "Nh·∫≠p m√£ OTP" ==========
    btnShowForm.addEventListener("click", () => {
      stateInfo.style.display = "none";
      stateForm.style.display = "block";
      otpInput.focus();
    });

    // ========== 3. Verify OTP ==========
    btnConfirm.addEventListener("click", submitCode);

    async function submitCode() {
      const code = otpInput.value.trim();
      if (code.length !== 6) return;

      btnConfirm.disabled = true;
      showAlert("", null); // clear alert

      try {
        const res = await fetch((API || "") + "/api/auth/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, code }),
        });

        const data = await res.json().catch(() => ({}));

        // OTP ƒë√∫ng
        if (res.ok && data && data.success) {
          showAlert("X√°c th·ª±c th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.", true);

          // ƒê√°nh d·∫•u user ƒë√£ verify (tu·ª≥ backend b·∫°n c√≥ tr·∫£ access_token/user hay kh√¥ng)
          if (data.access_token) {
            localStorage.setItem("access_token", data.access_token);
          }
          if (data.user) {
            localStorage.setItem("user", JSON.stringify(data.user));
          }

          // chuy·ªÉn qua /login sau 1s
          setTimeout(() => {
            window.location.href = "/login";
          }, 1000);

          return;
        }

        // OTP sai / h·∫øt h·∫°n
        showAlert(
          data.message ||
            "M√£ OTP kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng th·ª≠ l·∫°i.",
          false
        );
        otpInput.value = "";
        otpInput.focus();
        btnConfirm.disabled = true;
      } catch (err) {
        console.error("verify-otp error:", err);
        showAlert("L·ªói k·∫øt n·ªëi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.", false);
        otpInput.focus();
      } finally {
        // Cho ph√©p nh·∫≠p l·∫°i
        btnConfirm.disabled = otpInput.value.trim().length !== 6;
      }
    }

    function showAlert(msg, ok) {
      if (!msg) {
        otpAlert.classList.add("d-none");
        otpAlert.textContent = "";
        return;
      }
      otpAlert.classList.remove("d-none", "alert-danger", "alert-success");
      otpAlert.classList.add(ok ? "alert-success" : "alert-danger");
      otpAlert.textContent = msg;
    }

    // ========== 4. Cooldown resend OTP 30s ==========
    // Y√™u c·∫ßu c·ªßa b·∫°n:
    // - V·ª´a v√†o trang: n√∫t resend b·ªã disable, c√≥ ƒë·∫øm ng∆∞·ª£c 30s
    // - H·∫øt 30s -> enable c·∫£ 2 n√∫t resend
    // - Khi nh·∫•n resend -> g·ªçi /api/auth/resend-otp r·ªìi reset countdown 30s n·ªØa

    let remain = 30;
    let timer = null;

    function updateCountdownUI() {
      cdInfoSec.textContent = remain;
      cdFormSec.textContent = remain;
    }

    function setResendEnabled(enabled) {
      btnResendInfo.disabled = !enabled;
      btnResendForm.disabled = !enabled;
      countdownInfo.style.display = enabled ? "none" : "inline";
      countdownForm.style.display = enabled ? "none" : "inline";

      if (enabled) {
        btnResendInfo.textContent = "G·ª≠i l·∫°i m√£";
        btnResendForm.textContent = "G·ª≠i l·∫°i m√£";
      } else {
        btnResendInfo.textContent = "G·ª≠i l·∫°i m√£";
        btnResendForm.textContent = "G·ª≠i l·∫°i m√£";
      }
    }

    function startCooldown() {
      remain = 30;
      setResendEnabled(false);
      updateCountdownUI();

      if (timer) clearInterval(timer);
      timer = setInterval(() => {
        remain--;
        if (remain <= 0) {
          clearInterval(timer);
          setResendEnabled(true);
        } else {
          updateCountdownUI();
        }
      }, 1000);
    }

    async function resendOtp() {
      // b·∫≠t cooldown l·∫°i ngay khi b·∫•m
      startCooldown();
      showAlert("", null); // clear alert

      try {
        const resp = await fetch((API || "") + "/api/auth/resend-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });
        const data = await resp.json().catch(() => ({}));

        if (!(resp.ok && data && data.success)) {
          // v√≠ d·ª• backend tr·∫£ 429 cooldown
          showAlert(
            data.message ||
              "Kh√¥ng th·ªÉ g·ª≠i l·∫°i m√£ OTP l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i sau.",
            false
          );
          return;
        }

        // g·ª≠i l·∫°i OK
        showAlert("ƒê√£ g·ª≠i l·∫°i m√£ OTP v√†o email c·ªßa b·∫°n.", true);
      } catch (err) {
        console.error("resend-otp error:", err);
        showAlert("L·ªói k·∫øt n·ªëi khi g·ª≠i l·∫°i m√£ OTP.", false);
      }
    }

    btnResendInfo.addEventListener("click", (e) => {
      e.preventDefault();
      if (btnResendInfo.disabled) return;
      resendOtp();
    });

    btnResendForm.addEventListener("click", (e) => {
      e.preventDefault();
      if (btnResendForm.disabled) return;
      resendOtp();
    });

    // Kh·ªüi ch·∫°y cooldown l·∫ßn ƒë·∫ßu khi load trang
    startCooldown();
  })();
</script>
{% endblock %}
