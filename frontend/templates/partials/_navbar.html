<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container-fluid">
    <!-- Logo -->
    <a class="navbar-brand fw-semibold" href="{{ url_for('web.index') }}">
      SVFinance
    </a>

    <!-- Toggle mobile -->
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#topNav"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <!-- Badge AI -->
        <li class="nav-item me-3">
          <span class="badge text-bg-secondary">
            AI {{ 'On' if 'ai' in FEATURE_FLAGS else 'Off' }}
          </span>
        </li>

        <!-- Chuông thông báo -->
        <li class="nav-item dropdown me-2">
          <button
            id="btnNoti"
            type="button"
            class="btn btn-light border position-relative"
            data-bs-toggle="dropdown"
            data-bs-auto-close="outside"
            aria-expanded="false"
            aria-label="Thông báo"
          >
            <i class="bi bi-bell"></i>
            <span
              id="notiBadge"
              class="badge bg-danger position-absolute top-0 start-100 translate-middle d-none"
              >0</span
            >
          </button>

          <div
            class="dropdown-menu dropdown-menu-end dropdown-menu-noti shadow"
            aria-labelledby="btnNoti"
          >
            <div
              class="section-head d-flex justify-content-between align-items-center border-bottom"
            >
              <strong>Thông báo ngân sách</strong>
              <small id="notiMonth" class="text-muted"></small>
            </div>
            <div id="notiList">
              <div class="text-muted small px-3 py-2">Chưa có thông báo.</div>
            </div>
          </div>
        </li>

        <!-- KHU VỰC USER / LOGIN: sẽ toggle bằng JS -->
        <!-- 1. Dropdown user (ẩn mặc định) -->
        <li class="nav-item dropdown d-none" id="navUserWrapper">
          <a
            class="nav-link d-flex align-items-center gap-2"
            href="#"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <img
              id="navUserAvatar"
              src="{{ url_for('static', filename='img/avatar-placeholder.png') }}"
              alt="Avatar"
              class="rounded-circle"
              style="width: 32px; height: 32px; object-fit: cover"
              onerror="this.src='{{ url_for('static', filename='img/avatar-placeholder.png') }}'"
            />
            <i class="bi bi-caret-down-fill small"></i>
          </a>

          <ul
            class="dropdown-menu dropdown-menu-end shadow"
            style="min-width: 260px"
          >
            <li class="px-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <img
                  id="navUserAvatarLg"
                  src="{{ url_for('static', filename='img/avatar-placeholder.png') }}"
                  alt="Avatar"
                  class="rounded-circle"
                  style="width: 40px; height: 40px; object-fit: cover"
                  onerror="this.src='{{ url_for('static', filename='img/avatar-placeholder.png') }}'"
                />
                <div class="min-w-0">
                  <div class="fw-semibold text-truncate" id="navUserName">
                    Sinh viên
                  </div>
                  <small
                    class="text-muted text-truncate d-block"
                    id="navUserEmail"
                  ></small>
                </div>
              </div>
            </li>

            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item" href="{{ url_for('web.dashboard') }}">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{{ url_for('web.settings') }}">
                <i class="bi bi-gear me-2"></i>Cài đặt
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item text-danger" id="btnLogout" href="#">
                <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
              </a>
            </li>
          </ul>
        </li>

        <!-- 2. Link Đăng nhập (hiện mặc định) -->
        <li class="nav-item" id="navLoginWrapper">
          <a class="nav-link" href="{{ url_for('web.login') }}">Đăng nhập</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  // Navbar runtime logic: đọc localStorage để quyết định hiển thị
  (function () {
    try {
      const userRaw = localStorage.getItem("user") || "null";
      const user = JSON.parse(userRaw);
      const token = localStorage.getItem("access_token");

      const navUserWrapper = document.getElementById("navUserWrapper");
      const navLoginWrapper = document.getElementById("navLoginWrapper");
      const avatarEl = document.getElementById("navUserAvatar");
      const avatarLgEl = document.getElementById("navUserAvatarLg");
      const nameEl = document.getElementById("navUserName");
      const emailEl = document.getElementById("navUserEmail");
      const btnLogout = document.getElementById("btnLogout");

      // nếu chưa login -> cứ để nút Đăng nhập
      if (!user || !token) {
        navLoginWrapper?.classList.remove("d-none");
        navUserWrapper?.classList.add("d-none");
        return;
      }

      // nếu đã login -> hiển thị dropdown user, ẩn nút Đăng nhập
      navLoginWrapper?.classList.add("d-none");
      navUserWrapper?.classList.remove("d-none");

      const avatarSrc =
        user.avatar ||
        user.avatar_url ||
        user.photo_url ||
        user.image ||
        "{{ url_for('static', filename='img/avatar-placeholder.png') }}";

      if (avatarEl) avatarEl.src = avatarSrc;
      if (avatarLgEl) avatarLgEl.src = avatarSrc;
      if (nameEl) {
        nameEl.textContent =
          user.full_name || user.name || user.username || "Sinh viên";
      }
      if (emailEl) {
        emailEl.textContent = user.email || "";
      }

      // Logout: clear localStorage và quay về /login
      btnLogout?.addEventListener("click", async (e) => {
        e.preventDefault();

        // optional: ping API /api/auth/logout để revoke token trong blocklist
        try {
          const token = localStorage.getItem("access_token");
          if (token) {
            await fetch("/api/auth/logout", {
              method: "POST",
              headers: { Authorization: "Bearer " + token },
            });
          }
        } catch (err) {
          console.warn("logout api failed (ignored)", err);
        }

        localStorage.removeItem("token_type");
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("user");

        window.location.href = "/login?logout_ok=1";
      });
    } catch (err) {
      console.warn("navbar init error:", err);
    }
  })();
</script>
