<nav class="navbar navbar-expand-lg bg-white border-bottom" style="position: sticky; top: 0; z-index: 1030;">
  <div class="container-fluid">
    <a class="navbar-brand fw-semibold" href="{{ url_for('web.index') }}">
      SVFinance
    </a>

    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#topNav"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <li class="nav-item me-3 d-flex align-items-center" id="navThemeToggleWrapper">
          <i class="bi bi-sun-fill text-muted small me-2"></i>
          
          <div class="form-check form-switch p-0">
            <input
              class="form-check-input"
              type="checkbox"
              id="themeToggle"
              role="switch"
              onclick="ThemeManager.toggleTheme()"
            />
          </div>
          
          <i class="bi bi-moon-fill text-muted small ms-2"></i>
        </li>
        
        <li class="nav-item dropdown me-2">
          <button
            id="btnNoti"
            type="button"
            class="btn btn-outline-secondary border position-relative"
            data-bs-toggle="dropdown"
            data-bs-auto-close="outside"
            aria-expanded="false"
            aria-label="Thông báo"
          >
            <i class="bi bi-bell"></i>
            <span
              id="notiBadge"
              class="badge bg-danger position-absolute top-0 start-100 translate-middle d-none"
              >0</span
            >
          </button>

          <div
            class="dropdown-menu dropdown-menu-end dropdown-menu-noti shadow"
            aria-labelledby="btnNoti"
          >
            <div
              class="section-head d-flex justify-content-between align-items-center border-bottom"
            >
              <strong>Thông báo ngân sách</strong>
              <small id="notiMonth" class="text-muted"></small>
            </div>
            <div id="notiList">
              <div class="text-muted small px-3 py-2">Chưa có thông báo.</div>
            </div>
          </div>
        </li>

        <li class="nav-item dropdown d-none" id="navUserWrapper">
          <a
            class="nav-link d-flex align-items-center gap-2"
            href="#"
            role="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <img
              id="navUserAvatar"  
              src="{{ url_for('static', filename='img/ai-robot-3d.png') }}"
              alt="Avatar"
              class="rounded-circle"
              style="width: 32px; height: 32px; object-fit: cover"
              onerror="this.src='{{ url_for('static', filename='img/ai-robot-3d.png') }}'"
            />
            <i class="bi bi-caret-down-fill small"></i>
          </a>

          <ul
            class="dropdown-menu dropdown-menu-end shadow"
            style="min-width: 260px"
          >
            <li class="px-3 py-2">
              <div class="d-flex align-items-center gap-2">
                <img
                  id="navUserAvatarDropdown" 
                  src="{{ url_for('static', filename='img/ai-robot-3d.png') }}"
                  alt="Avatar"
                  class="rounded-circle"
                  style="width: 40px; height: 40px; object-fit: cover"
                  onerror="this.src='{{ url_for('static', filename='img/ai-robot-3d.png') }}'"
                />
                <div class="min-w-0">
                  <div class="fw-semibold text-truncate" id="navUserName">
                    Sinh viên
                  </div>
                  <small
                    class="text-muted text-truncate d-block"
                    id="navUserEmail"
                  ></small>
                </div>
              </div>
            </li>

            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item" href="{{ url_for('web.dashboard') }}">
                <i class="bi bi-speedometer2 me-2"></i>Dashboard
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{{ url_for('web.settings') }}">
                <i class="bi bi-gear me-2"></i>Cài đặt
              </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
              <a class="dropdown-item text-danger" id="btnLogout" href="#">
                <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
              </a>
            </li>
          </ul>
        </li>

        <li class="nav-item" id="navLoginWrapper">
          <a class="nav-link" href="{{ url_for('web.login') }}">Đăng nhập</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  // Hàm khởi tạo/cập nhật navbar
  function initNavbar() {
    try {
      const userRaw = localStorage.getItem("user") || "null";
      const user = JSON.parse(userRaw);
      const token = localStorage.getItem("access_token");

      const navUserWrapper = document.getElementById("navUserWrapper");
      const navLoginWrapper = document.getElementById("navLoginWrapper");
      const notiItem = document.querySelector(".nav-item.dropdown.me-2");

      // Lấy các thẻ Avatar theo ID đã fix
      const avatarEl = document.getElementById("navUserAvatar");
      const avatarDropdownEl = document.getElementById("navUserAvatarDropdown"); 

      const nameEl = document.getElementById("navUserName");
      const emailEl = document.getElementById("navUserEmail");
      const btnLogout = document.getElementById("btnLogout");

      // Nếu chưa login
      if (!user || !token) {
        if (navUserWrapper) navUserWrapper.classList.add("d-none");
        if (navLoginWrapper) navLoginWrapper.classList.remove("d-none");
        if (notiItem) notiItem.classList.add("d-none");
        return;
      }

      // Nếu đã login
      if (navUserWrapper) navUserWrapper.classList.remove("d-none");
      if (navLoginWrapper) navLoginWrapper.classList.add("d-none");
      if (notiItem) notiItem.classList.remove("d-none");

      // Hàm cập nhật avatar
      const updateAvatarDisplay = (avatarUrl) => {
        if (avatarEl) avatarEl.src = avatarUrl;
        if (avatarDropdownEl) avatarDropdownEl.src = avatarUrl;
      };

      // Fetch user profile từ API để lấy avatar mới nhất từ database
      if (token) {
        fetch("/api/user/profile", {
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            const userProfile = data.data || data.user; // Endpoint trả về data hoặc user
            if (userProfile) {
              // Cập nhật user trong localStorage
              const updatedUser = { ...user, ...userProfile };
              localStorage.setItem("user", JSON.stringify(updatedUser));
              
              // Cập nhật avatar từ database
              let avatarUrl = "{{ url_for('static', filename='img/ai-robot-3d.png') }}";
              if (userProfile.avatar) {
                // avatar có thể là: /uploads/avatars/xxx hoặc avatars/xxx hoặc xxx
                let avatarPath = userProfile.avatar;
                if (!avatarPath.startsWith("/")) {
                  avatarPath = "/uploads/" + avatarPath;
                }
                // Thêm timestamp để bypass cache
                const separator = avatarPath.includes("?") ? "&" : "?";
                avatarUrl = avatarPath + separator + "t=" + Date.now();
              }
              updateAvatarDisplay(avatarUrl);
              
              // Cập nhật tên và email
              if (nameEl) nameEl.textContent = userProfile.full_name || "Sinh viên";
              if (emailEl) emailEl.textContent = userProfile.email || "";
            }
          })
          .catch((err) => {
            console.warn("Fetch profile error:", err);
            // Fallback: sử dụng avatar từ localStorage
            let avatarSrc = "{{ url_for('static', filename='img/ai-robot-3d.png') }}";
            if (user.avatar) {
              const separator = user.avatar.includes("/") ? "?" : "";
              avatarSrc = (user.avatar.startsWith("/") ? user.avatar : "/uploads/" + user.avatar) 
                + separator + "t=" + Date.now();
            }
            
            if (avatarEl) avatarEl.src = avatarSrc;
            if (avatarDropdownEl) avatarDropdownEl.src = avatarSrc;
          });
      } else {
        // Nếu không có token, show placeholder
        if (avatarEl) avatarEl.src = "{{ url_for('static', filename='img/ai-robot-3d.png') }}";
        if (avatarDropdownEl) avatarDropdownEl.src = "{{ url_for('static', filename='img/ai-robot-3d.png') }}";
      }
      
      if (nameEl) {
        nameEl.textContent =
          user.full_name || user.name || user.username || "Sinh viên";
      }
      if (emailEl) {
        emailEl.textContent = user.email || "";
      }

      if (
        window.BudgetNotify &&
        typeof window.BudgetNotify.init === "function"
      ) {
        window.BudgetNotify.init();
      }
      
      // Khởi tạo trạng thái nút toggle (Theme Toggle)
      if (window.ThemeManager) {
        window.ThemeManager.applyCurrent();
      }

      // Logic Logout
      btnLogout?.addEventListener("click", async (e) => {
        e.preventDefault();

        try {
          const token = localStorage.getItem("access_token");
          if (token) {
            // Giả định bạn có endpoint '/api/auth/logout'
            await fetch("/api/auth/logout", {
              method: "POST",
              headers: { Authorization: "Bearer " + token },
            });
          }
        } catch (err) {
          console.warn("logout api failed (ignored)", err);
        }

        // Xóa tất cả các token và thông tin user
        localStorage.removeItem("token_type");
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        localStorage.removeItem("user");
        localStorage.removeItem("token_expire");
        
        // Chuyển hướng về trang đăng nhập
        window.location.href = "{{ url_for('web.login') }}";
      });

    } catch (err) {
      console.warn("navbar init error:", err);
    }
  }

  // Gọi hàm khi trang load xong
  document.addEventListener("DOMContentLoaded", initNavbar);
  
  // Cũng gọi ngay (trong trường hợp script load sau content)
  initNavbar();
</script>