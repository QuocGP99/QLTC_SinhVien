{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  .kpi { border:0; border-radius:16px; color:#fff }
  .kpi-blue   { background:linear-gradient(135deg,#3b82f6,#2563eb) }
  .kpi-red    { background:linear-gradient(135deg,#ef4444,#dc2626) }
  .kpi-green  { background:linear-gradient(135deg,#22c55e,#16a34a) }
  .kpi .val   { font-size:1.35rem; font-weight:700 }
  .card-rounded{ border-radius:16px }
  .badge-chip{ font-size:.72rem }
  .progress{ height:10px }
  .dim{ opacity:.85 }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h1 class="h4 fw-semibold">Quản lý ngân sách</h1>
    <div class="text-muted">Tạo & quản lý ngân sách hằng tháng với trợ lý AI.</div>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary"><i class="bi bi-magic me-1"></i> Áp dụng gợi ý AI</button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#budgetModal">
      <i class="bi bi-plus-lg me-1"></i> Thêm ngân sách
    </button>
  </div>
</div>

<!-- KPI -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card kpi kpi-blue">
      <div class="card-body">
        <div class="small">Tổng hạn mức tháng</div>
        <div id="kpiLimit" class="val">₫0</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi kpi-red">
      <div class="card-body">
        <div class="small">Đã chi</div>
        <div id="kpiSpent" class="val">₫0</div>
        <div class="small dim"><span id="kpiPercent">0</span>% đã dùng</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi kpi-green">
      <div class="card-body">
        <div class="small">Còn lại</div>
        <div id="kpiRemain" class="val">₫0</div>
      </div>
    </div>
  </div>
</div>

<!-- Hộp gợi ý AI -->
<div class="card card-rounded shadow-sm mb-3">
  <div class="card-body">
    <div class="fw-semibold mb-2"><i class="bi bi-stars me-1"></i> Gợi ý ngân sách từ AI</div>
    <div class="row g-2">
      <div class="col-lg-6">
        <div class="p-3 rounded-3 border" style="background:#fff7ed">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">Tối ưu mục Ăn uống</div>
            <span class="badge text-bg-warning badge-chip">cảnh báo</span>
          </div>
          <div class="small text-muted">Giảm ~₫120.000/tháng bằng cách lập thực đơn và nấu tại nhà.</div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="p-3 rounded-3 border" style="background:#ecfeff">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">Cảnh báo Giải trí</div>
            <span class="badge text-bg-danger badge-chip">cao</span>
          </div>
          <div class="small text-muted">Bạn đã dùng 90% hạn mức cho Giải trí. Cân nhắc giảm các khoản thuê bao.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Danh mục ngân sách -->
<div class="card card-rounded shadow-sm">
  <div class="card-body">
    <div class="fw-semibold mb-3">Danh mục ngân sách</div>
    <div id="budgetList" class="vstack gap-3">
      <!-- JS render -->
    </div>
  </div>
</div>

<!-- Modal thêm/sửa -->
<div class="modal fade" id="budgetModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="budgetForm">
      <div class="modal-header">
        <h5 class="modal-title">Thêm ngân sách</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Danh mục</label>
          <input class="form-control" name="category" placeholder="Ví dụ: Ăn uống" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Hạn mức (₫)</label>
          <input type="number" class="form-control" name="limit" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Đã chi hiện tại (₫)</label>
          <input type="number" class="form-control" name="spent" value="0" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal" type="button">Huỷ</button>
        <button class="btn btn-primary" type="submit">Lưu</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // ===== Demo data (sau nối BE sẽ thay bằng gọi API) =====
  let budgets = [
    {category:"Ăn uống",       limit:500000, spent:450000, ai:"AI gợi ý: -₫80.000"},
    {category:"Di chuyển",     limit:300000, spent:280000, ai:"AI gợi ý: -₫25.000"},
    {category:"Giáo trình",    limit:250000, spent:200000, ai:"AI gợi ý: -₫20.000"},
    {category:"Giải trí",      limit:200000, spent:180000, ai:"AI gợi ý: -₫17.500"},
    {category:"Nhà trọ",       limit:550000, spent:144000, ai:"Ổn định"}
  ];

  const fmt = n => "₫" + Number(n||0).toLocaleString('vi-VN');

  function kpi(){
    const limit = budgets.reduce((s,b)=>s+b.limit,0);
    const spent = budgets.reduce((s,b)=>s+b.spent,0);
    const remain = Math.max(0, limit-spent);
    document.getElementById('kpiLimit').textContent  = fmt(limit);
    document.getElementById('kpiSpent').textContent  = fmt(spent);
    document.getElementById('kpiRemain').textContent = fmt(remain);
    document.getElementById('kpiPercent').textContent = limit? Math.round(spent/limit*100):0;
  }

  function itemBadge(pct){
    if (pct >= 100) return '<span class="badge text-bg-danger badge-chip">quá hạn</span>';
    if (pct >= 90)  return '<span class="badge text-bg-warning badge-chip">cảnh báo</span>';
    return '<span class="badge text-bg-success badge-chip">ổn định</span>';
  }

  function render(){
    const wrap = document.getElementById('budgetList'); wrap.innerHTML="";
    budgets.forEach((b, idx)=>{
      const pct = Math.round((b.spent/b.limit)*100);
      const remain = Math.max(0, b.limit-b.spent);
      wrap.insertAdjacentHTML('beforeend', `
        <div class="border rounded-4 p-3">
          <div class="d-flex justify-content-between align-items-start">
            <div class="fw-semibold">${b.category} ${itemBadge(pct)}</div>
            <div class="text-muted small">
              ${fmt(b.spent)} / ${fmt(b.limit)}
              <div class="d-inline-flex gap-2 ms-2">
                <button class="btn btn-sm btn-outline-secondary" data-act="edit" data-idx="${idx}" title="Sửa"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-outline-secondary" data-act="dup"  data-idx="${idx}" title="Nhân bản"><i class="bi bi-files"></i></button>
                <button class="btn btn-sm btn-outline-danger"    data-act="del"  data-idx="${idx}" title="Xoá"><i class="bi bi-trash"></i></button>
              </div>
            </div>
          </div>

          <div class="progress my-2">
            <div class="progress-bar ${pct>=100?'bg-danger':pct>=90?'bg-warning':'bg-primary'}" style="width:${Math.min(100,pct)}%"></div>
          </div>
          <div class="d-flex justify-content-between small">
            <span class="text-muted">${pct}% đã dùng</span>
            <span class="text-success">${fmt(remain)} còn lại</span>
          </div>

          <div class="mt-2 p-2 rounded-3 border bg-body-tertiary d-flex justify-content-between align-items-center">
            <span class="small text-muted">${b.ai}</span>
            <button class="btn btn-sm btn-outline-primary">Áp dụng</button>
          </div>
        </div>
      `);
    });
    kpi();
  }

  // --- Events ---
  document.getElementById('budgetList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const i = Number(btn.dataset.idx);
    const act = btn.dataset.act;
    if (act==='del'){ budgets.splice(i,1); render(); }
    if (act==='dup'){ budgets.splice(i+1,0,{...budgets[i]}); render(); }
    if (act==='edit'){
      const b = budgets[i];
      const form = document.getElementById('budgetForm');
      form.category.value = b.category; form.limit.value = b.limit; form.spent.value = b.spent;
      form.dataset.edit = i; // đánh dấu đang sửa
      document.querySelector('#budgetModal .modal-title').textContent = 'Sửa ngân sách';
      new bootstrap.Modal(document.getElementById('budgetModal')).show();
    }
  });

  document.getElementById('budgetForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const obj = Object.fromEntries(fd.entries());
    obj.limit = Number(obj.limit); obj.spent = Number(obj.spent);
    const editIdx = e.target.dataset.edit;
    if (editIdx !== undefined){
      budgets[Number(editIdx)] = obj;
      delete e.target.dataset.edit;
      document.querySelector('#budgetModal .modal-title').textContent = 'Thêm ngân sách';
    } else {
      budgets.push(obj);
    }
    bootstrap.Modal.getInstance(document.getElementById('budgetModal')).hide();
    e.target.reset();
    render();
  });

  // init
  render();
})();
</script>
{% endblock %}
