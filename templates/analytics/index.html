{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  .card-rounded{ border-radius:16px }
  .kpi {border:0;border-radius:16px;background:#fff}
  .kpi .val{font-size:1.35rem;font-weight:700}
  .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;font-size:.75rem;background:#f4f6ff;border:1px solid #e8ebff;color:#334155}
  /* tƒÉng chi·ªÅu cao canvas m·ªôt ch√∫t */
  .chart-tall{ height: 240px !important; }   /* tr∆∞·ªõc ~150px */
  .chart-mid { height: 200px !important; }   /* tr∆∞·ªõc ~120‚Äì150px */
</style>
{% endblock %}

{% block content %}
<h1 class="h4 fw-semibold">Ph√¢n t√≠ch t√†i ch√≠nh</h1>
<p class="text-muted mb-3">T·ªïng h·ª£p, ph√¢n t√≠ch v√† ƒë√°nh gi√° s·ª©c kh·ªèe t√†i ch√≠nh c·ªßa b·∫°n.</p>

<!-- B·ªô l·ªçc -->
<div class="card card-rounded shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">T·ª´ ng√†y</label>
        <input type="date" id="fromDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">ƒê·∫øn ng√†y</label>
        <input type="date" id="toDate" class="form-control">
      </div>
      <div class="col-md-3">
        <label class="form-label">Danh m·ª•c</label>
        <select id="filterCat" class="form-select">
          <option value="">T·∫•t c·∫£</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary w-100" id="btnApply"><i class="bi bi-funnel me-1"></i> √Åp d·ª•ng</button>
        <div class="dropstart">
          <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-download"></i> Xu·∫•t</button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="exportCsv">Xu·∫•t CSV</a></li>
            <li><a class="dropdown-item" href="#" id="printPdf">In / L∆∞u PDF</a></li>
            <li><a class="dropdown-item" href="#" id="saveCharts">T·∫£i ·∫£nh bi·ªÉu ƒë·ªì</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- KPI h√†ng ƒë·∫ßu -->
<div class="row g-3 mb-3">
  <div class="col-md-4">
    <div class="card kpi shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div class="text-muted small">T·ªïng chi</div>
          <span class="chip">Xu h∆∞·ªõng</span>
        </div>
        <div id="kpiTotal" class="val text-danger">0 ‚Ç´</div>
        <div id="kpiTrend" class="small text-muted">+0% so v·ªõi th√°ng tr∆∞·ªõc</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div class="text-muted small">T·ª∑ l·ªá ti·∫øt ki·ªám</div>
          <span class="chip">Thu nh·∫≠p ti·∫øt ki·ªám</span>
        </div>
        <div id="kpiSaveRate" class="val text-success">0%</div>
        <div class="progress my-1" style="height:10px">
          <div id="kpiSaveBar" class="progress-bar bg-success" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card kpi shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div class="text-muted small">Trung b√¨nh/ng√†y</div>
          <span class="chip">Th√°ng hi·ªán t·∫°i</span>
        </div>
        <div id="kpiDaily" class="val text-primary">0 ‚Ç´</div>
        <div class="text-muted small">S·ªë giao d·ªãch: <span id="kpiCount">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- H√†ng bi·ªÉu ƒë·ªì 1 -->
<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card card-rounded shadow-sm">
      <div class="card-body">
        <div class="fw-semibold mb-2">Xu h∆∞·ªõng chi theo ng√†y</div>
        <canvas id="lineDaily" class="chart-tall"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card card-rounded shadow-sm">
      <div class="card-body">
        <div class="fw-semibold mb-2">C∆° c·∫•u chi theo danh m·ª•c</div>
        <canvas id="pieCat" class="chart-tall"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- So s√°nh theo th√°ng -->
<div class="card card-rounded shadow-sm mb-3">
  <div class="card-body">
    <div class="fw-semibold mb-2">So s√°nh theo th√°ng</div>
    <canvas id="barMonthly" class="chart-mid"></canvas>
  </div>
</div>

<!-- H√†ng bi·ªÉu ƒë·ªì 2 -->
<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card card-rounded shadow-sm">
      <div class="card-body">
        <div class="fw-semibold mb-2">Xu h∆∞·ªõng chi theo h·∫°ng m·ª•c</div>
        <canvas id="lineCategory" class="chart-tall"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card card-rounded shadow-sm">
      <div class="card-body">
        <div class="fw-semibold mb-2">Theo d√µi m·ª•c ti√™u ti·∫øt ki·ªám</div>
        <canvas id="savingsTrend" class="chart-tall"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- AI Panel -->
<div class="row g-3 mb-3">
  <div class="col-md-6">
    <div class="card card-rounded shadow-sm h-100">
      <div class="card-body text-center">
        <h6 class="fw-semibold">ƒêi·ªÉm s·ª©c kh·ªèe t√†i ch√≠nh (AI)</h6>
        <div id="aiScore" class="display-5 text-primary fw-bold">8.2</div>
        <div class="progress my-2" style="height:8px;">
          <div class="progress-bar bg-primary" id="aiScoreBar" style="width:82%"></div>
        </div>
        <p class="text-muted small">AI ƒë√°nh gi√° d·ª±a tr√™n hi·ªáu qu·∫£ chi ti√™u, ti·∫øt ki·ªám v√† m·ª©c tu√¢n th·ªß ng√¢n s√°ch.</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card card-rounded shadow-sm h-100">
      <div class="card-body">
        <h6 class="fw-semibold mb-2">G·ª£i √Ω h√†nh ƒë·ªông t·ª´ AI</h6>
        <ul id="aiTips" class="list-group list-group-flush small"></ul>
      </div>
    </div>
  </div>
</div>

<!-- B·∫£ng giao d·ªãch -->
<div class="card card-rounded shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Danh s√°ch giao d·ªãch</div>
      <div class="text-muted small" id="rangeLabel"></div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Ng√†y</th>
            <th>M√¥ t·∫£</th>
            <th>Danh m·ª•c</th>
            <th>Ph∆∞∆°ng th·ª©c</th>
            <th class="text-end">S·ªë ti·ªÅn</th>
          </tr>
        </thead>
        <tbody id="txTable"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  // ====== MOCK d·ªØ li·ªáu (gi·ªØ nguy√™n c√°ch b·∫°n ƒëang mock/ho·∫∑c thay b·∫±ng api.get khi n·ªëi BE) ======
  const CATS = ["ƒÇn u·ªëng","Di chuy·ªÉn","Gi√°o tr√¨nh","Gi·∫£i tr√≠","Nh√† tr·ªç"];
  const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const money = n => (n??0).toLocaleString('vi-VN',{style:'currency',currency:'VND',maximumFractionDigits:0});

  const txSeed = (()=>{ const arr=[]; const today = new Date();
    for(let i=0;i<150;i++){
      const d = new Date(today); d.setDate(d.getDate()-rnd(0,85));
      arr.push({ date: d.toISOString().slice(0,10),
        desc: ["Cafe","B·ªØa tr∆∞a","Xe bu√Ωt","S√°ch","Phim","Thu√™ tr·ªç"][rnd(0,5)],
        category: CATS[rnd(0,4)],
        method: ["Ti·ªÅn m·∫∑t","Th·∫ª ghi n·ª£","Th·∫ª t√≠n d·ª•ng"][rnd(0,2)],
        amount: rnd(20000, 400000)
      });
    }
    return arr.sort((a,b)=>a.date.localeCompare(b.date));
  })();

  async function loadTx(start, end, category){
    return txSeed.filter(t => t.date>=start && t.date<=end && (!category || t.category===category));
  }
  async function loadAI(start, end){
    return { score: 8.2, tips:[
      "Gi·∫£m chi ph√≠ ƒÇn u·ªëng ~10% ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm 9.0.",
      "TƒÉng t·ª∑ l·ªá ti·∫øt ki·ªám th√™m 5% trong 30 ng√†y t·ªõi.",
      "Duy tr√¨ m·ª©c chi trung b√¨nh hi·ªán t·∫°i."
    ], savingRate: 0.156, monthTrendPct: 0.123 };
  }

  function initFilters(){
    const cat = document.getElementById('filterCat');
    CATS.forEach(c=>cat.insertAdjacentHTML('beforeend', `<option>${c}</option>`));
    const to = new Date(), from = new Date(); from.setDate(to.getDate()-30);
    document.getElementById('fromDate').value = from.toISOString().slice(0,10);
    document.getElementById('toDate').value   = to.toISOString().slice(0,10);
  }

  const CH={};
  function draw(id, cfg){ const el=document.getElementById(id); if(CH[id]) CH[id].destroy(); CH[id]=new Chart(el, cfg); return CH[id]; }

  async function apply(){
    const from = fromDate.value, to = toDate.value, cat = filterCat.value;
    const tx = await loadTx(from,to,cat); const ai = await loadAI(from,to);

    // KPI
    const total = tx.reduce((s,x)=>s+x.amount,0);
    const days = Math.max(1,(new Date(to)-new Date(from))/86400000+1);
    kpiTotal.textContent = money(total);
    kpiDaily.textContent = money(total/days);
    kpiCount.textContent = tx.length;
    kpiTrend.textContent = `${(ai.monthTrendPct*100).toFixed(1)}% so v·ªõi th√°ng tr∆∞·ªõc`;
    kpiSaveRate.textContent = `${(ai.savingRate*100).toFixed(1)}%`;
    kpiSaveBar.style.width = `${ai.savingRate*100}%`;
    rangeLabel.textContent = `T·ª´ ${from} ƒë·∫øn ${to} (${tx.length} giao d·ªãch)`;

    // B·∫£ng
    txTable.innerHTML = tx.slice().reverse().map(r=>`
      <tr>
        <td>${new Date(r.date).toLocaleDateString('vi-VN')}</td>
        <td>${r.desc}</td>
        <td>${r.category}</td>
        <td>${r.method}</td>
        <td class="text-end text-danger fw-semibold">${money(r.amount)}</td>
      </tr>`).join('');

    // Gom d·ªØ li·ªáu
    const byDay={}, byCat={}, byMonth={};
    tx.forEach(r=>{
      byDay[r.date]=(byDay[r.date]||0)+r.amount;
      byCat[r.category]=(byCat[r.category]||0)+r.amount;
      const m=r.date.slice(0,7); byMonth[m]=(byMonth[m]||0)+r.amount;
    });

    // Bi·ªÉu ƒë·ªì ‚Äî nh√£n ti·∫øng Vi·ªát
    const dSorted = Object.keys(byDay).sort((a,b)=>a.localeCompare(b));
    draw('lineDaily',{
      type:'line',
      data:{ labels:dSorted.map(d=>new Date(d).toLocaleDateString('vi-VN')),
        datasets:[{ label:'Chi ti√™u (‚Ç´)', data:dSorted.map(d=>byDay[d]), fill:false, tension:.25 }] },
      options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{
        label:(ctx)=>`Chi ti√™u: ${money(ctx.parsed.y)}`
      }}}}
    });

    draw('pieCat',{
      type:'pie',
      data:{ labels:Object.keys(byCat), datasets:[{ data:Object.values(byCat)}] },
      options:{ responsive:true, plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{
        label:(ctx)=>`${ctx.label}: ${money(ctx.parsed)}`
      }}}}
    });

    draw('barMonthly',{
      type:'bar',
      data:{ labels:Object.keys(byMonth), datasets:[{ label:'Chi ti√™u theo th√°ng (‚Ç´)', data:Object.values(byMonth)}] },
      options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{
        label:(ctx)=>`Th√°ng ${ctx.label}: ${money(ctx.parsed.y)}`
      }}}}
    });

    draw('lineCategory',{
      type:'line',
      data:{ labels:["10","11","12","01","02"], // demo
        datasets:[
          {label:'ƒÇn u·ªëng',   data:[330,420,380,470,450], borderColor:'#36a2eb'},
          {label:'Di chuy·ªÉn', data:[260,290,270,300,280], borderColor:'#ff6384'}
        ]},
      options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
    });

    draw('savingsTrend',{
      type:'line',
      data:{ labels:["10","11","12","01","02"],
        datasets:[{label:'Ti·∫øt ki·ªám (‚Ç´)', data:[240,170,320,150,260], fill:true,
          backgroundColor:'rgba(75,192,192,.2)', borderColor:'#4bc0c0'}]},
      options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
    });

    // AI Panel
    aiScore.textContent = ai.score.toFixed(1);
    aiScoreBar.style.width = `${ai.score*10}%`;
    aiTips.innerHTML = ai.tips.map(t=>`<li class="list-group-item">üí° ${t}</li>`).join('');

    // Export
    exportCsv.onclick = (e)=>{ e.preventDefault();
      const rows=[["date","desc","category","method","amount"]].concat(tx.map(r=>[r.date,r.desc,r.category,r.method,r.amount]));
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=`report_${from}_to_${to}.csv`; a.click();
    };
    printPdf.onclick = (e)=>{ e.preventDefault(); window.print(); };
    saveCharts.onclick = (e)=>{ e.preventDefault();
      ['lineDaily','pieCat','barMonthly','lineCategory','savingsTrend'].forEach((id,i)=>{
        const a=document.createElement('a'); a.href = CH[id].toBase64Image(); a.download=`chart_${i+1}.png`; a.click();
      });
    };
  }

  btnApply.addEventListener('click', apply);
  initFilters(); apply();
</script>
{% endblock %}
